<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>예산 관리 시스템 - 국립공원공단 야생생물보전원 사육곰 보호센터</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: '맑은 고딕', 'Malgun Gothic', '돋움', Dotum, sans-serif;
            background: #f5f7fa;
            color: #222;
            line-height: 1.8;
            min-height: 100vh;
            padding: 0;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0;
            background: white;
        }

        /* 정부기관 상단 헤더 */
        .gov-header {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 8px 0;
        }

        .gov-header-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .gov-header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .gov-logo-area {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .gov-logo-img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: white;
            border: 2px solid #003876;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .gov-logo-img img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 2px;
        }

        .gov-org-name {
            font-size: 14px;
            font-weight: 700;
            color: #003876;
        }

        .gov-header-right {
            font-size: 12px;
            color: #666;
        }

        /* 정부기관 네비게이션 바 */
        .gov-top-bar {
            background: #003876;
            padding: 0;
            border-bottom: 3px solid #002a56;
            position: sticky;
            top: 0;
            z-index: 999;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .gov-top-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 40px;
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            gap: 0;
        }

        .nav-title-full {
            flex: 1;
            background: #003876;
            padding: 16px 0;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-main-title {
            color: white;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 12px;
        }

        .fiscal-year-nav {
            display: inline-block;
            background: #00509e;
            color: white;
            padding: 2px 10px;
            border-radius: 2px;
            font-size: 11px;
            font-weight: 700;
            border: 1px solid #006ac3;
        }

        .nav-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            font-weight: 400;
            text-align: left;
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 0;
        }

        .nav-action-item {
            padding: 16px 20px;
            color: white;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            transition: background 0.2s;
            white-space: nowrap;
        }

        .nav-action-item:hover {
            background: #00509e;
        }

        .nav-action-item i {
            margin-right: 6px;
        }


        /* 필터 섹션 */
        .filter-section {
            background: #f8f9fb;
            border: 2px solid #d0d0d0;
            margin: 30px 40px 20px 40px;
            padding: 0;
        }

        .filter-header {
            background: white;
            padding: 12px 20px;
            border-bottom: 2px solid #d0d0d0;
        }

        .filter-header h3 {
            margin: 0;
            font-size: 15px;
            font-weight: 700;
            color: #003876;
        }

        .filter-header i {
            margin-right: 6px;
        }

        .filter-body {
            padding: 20px;
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-label {
            font-size: 12px;
            font-weight: 700;
            color: #333;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #bbb;
            background: white;
            font-size: 13px;
            min-width: 150px;
            font-family: '맑은 고딕', sans-serif;
        }

        .filter-input {
            padding: 8px 12px;
            border: 1px solid #bbb;
            background: white;
            font-size: 13px;
            min-width: 160px;
            font-family: '맑은 고딕', sans-serif;
        }

        input[type="date"].filter-input {
            min-width: 160px;
        }

        .filter-select:focus,
        .filter-input:focus {
            outline: none;
            border-color: #003876;
        }

        /* 대분류별 예산 현황 */
        .category-breakdown {
            margin-bottom: 20px;
            border: 2px solid #d0d0d0;
            background: white;
        }

        .breakdown-header {
            background: linear-gradient(135deg, #f8f9fb 0%, #e8eaf0 100%);
            padding: 15px 20px;
            border-bottom: 2px solid #d0d0d0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .breakdown-header:hover {
            background: linear-gradient(135deg, #e8eaf0 0%, #d8dae5 100%);
        }

        .breakdown-header-left {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .breakdown-category-name {
            font-size: 18px;
            font-weight: 700;
            color: #003876;
        }

        .breakdown-budget-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .breakdown-label {
            color: #666;
            font-weight: 600;
        }

        .breakdown-total {
            font-weight: 700;
            color: #003876;
            font-family: 'Courier New', monospace;
        }

        .breakdown-used {
            font-weight: 700;
            color: #1565c0;
            font-family: 'Courier New', monospace;
        }

        .breakdown-remaining {
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .breakdown-remaining.positive {
            color: #2e7d32;
        }

        .breakdown-remaining.negative {
            color: #c62828;
        }

        .breakdown-rate {
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .breakdown-separator {
            color: #ccc;
        }

        .breakdown-toggle {
            color: #003876;
            font-size: 18px;
            transition: transform 0.3s;
        }

        .breakdown-toggle.expanded {
            transform: rotate(180deg);
        }

        .breakdown-body {
            display: none;
            padding: 20px;
            background: #fafafa;
        }

        .breakdown-body.expanded {
            display: block;
        }

        .breakdown-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border: 1px solid #d0d0d0;
        }

        .breakdown-table th {
            background: #003876;
            color: white;
            padding: 12px;
            text-align: left;
            font-size: 13px;
            font-weight: 700;
            border: 1px solid #00509e;
        }

        .breakdown-table td {
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            font-size: 13px;
            vertical-align: top;
        }

        .breakdown-table tr:hover {
            background: #f5f5f5;
        }

        .breakdown-item-name {
            font-weight: 600;
            color: #111;
        }

        .breakdown-item-details {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
            line-height: 1.8;
        }

        .breakdown-item-details li {
            margin-left: 15px;
        }

        /* 통계 카드 - 공문서 스타일 */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 20px;
            margin: 30px 40px;
            padding: 0;
        }

        .stat-card {
            background: white;
            border: 2px solid #e0e0e0;
            padding: 20px 24px;
            position: relative;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            border-color: #003876;
            box-shadow: 0 2px 8px rgba(0, 56, 118, 0.1);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: #003876;
        }

        .stat-label {
            font-size: 13px;
            color: #555;
            margin-bottom: 10px;
            font-weight: 600;
            padding-left: 15px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #003876;
            font-family: 'Courier New', monospace;
            padding-left: 15px;
        }

        /* 섹션 - 공문서 박스 스타일 */
        .section {
            background: white;
            border: 2px solid #d0d0d0;
            margin: 30px 40px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 24px;
            background: #f8f9fb;
            border-bottom: 2px solid #d0d0d0;
        }

        .section-title {
            font-size: 17px;
            font-weight: 700;
            color: #003876;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: '▣';
            color: #003876;
            font-size: 18px;
        }

        .section-body {
            padding: 24px;
            background: white;
        }

        /* 버튼 - 공무원 스타일 */
        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 9px 18px;
            border: 1px solid #bbb;
            border-radius: 0;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: white;
            color: #333;
            font-family: '맑은 고딕', sans-serif;
        }

        .btn:hover {
            background: #f0f0f0;
            border-color: #999;
        }

        .btn-primary {
            background: #003876;
            color: white;
            border-color: #003876;
        }

        .btn-primary:hover {
            background: #00509e;
            border-color: #00509e;
        }

        .btn-success {
            background: white;
            color: #2e7d32;
            border-color: #2e7d32;
        }

        .btn-success:hover {
            background: #2e7d32;
            color: white;
        }

        .btn-excel {
            background: #217346;
            color: white;
            border-color: #217346;
        }

        .btn-excel:hover {
            background: #1a5c37;
            border-color: #1a5c37;
        }

        .btn-warning {
            background: white;
            color: #f57c00;
            border-color: #f57c00;
        }

        .btn-warning:hover {
            background: #f57c00;
            color: white;
        }

        .btn-danger {
            background: white;
            color: #c62828;
            border-color: #c62828;
        }

        .btn-danger:hover {
            background: #c62828;
            color: white;
        }

        .btn-sm {
            padding: 6px 14px;
            font-size: 12px;
        }

        /* Inline 편집 스타일 */
        .editable-cell {
            cursor: pointer;
            position: relative;
            transition: background-color 0.2s;
        }

        .editable-cell:hover {
            background-color: #f0f7ff !important;
        }

        .editable-cell.editing {
            padding: 0 !important;
            background-color: #fff3cd !important;
        }

        .editable-cell input {
            width: 100%;
            border: 2px solid #2196F3;
            padding: 8px;
            font-size: inherit;
            font-family: inherit;
            text-align: inherit;
            box-sizing: border-box;
        }

        .editable-cell input:focus {
            outline: none;
            border-color: #1976D2;
        }

        /* 테이블 - 공문서 표 스타일 */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #666;
            margin-top: 10px;
        }

        .data-table thead {
            background: #e8eaf0;
        }

        .data-table th {
            padding: 12px 8px;
            text-align: center;
            font-size: 13px;
            font-weight: 700;
            color: #222;
            border: 1px solid #999;
        }

        .data-table tbody tr {
            border: 1px solid #ccc;
        }

        .data-table tbody tr:hover {
            background: #f9f9f9;
        }

        .data-table td {
            padding: 10px 8px;
            text-align: center;
            font-size: 13px;
            color: #333;
            border: 1px solid #ccc;
        }

        .data-table td.text-left {
            text-align: left;
        }

        .data-table td.text-right {
            text-align: right;
            font-family: 'Courier New', monospace;
        }

        .data-table .amount {
            font-weight: 600;
            color: #111;
        }

        .data-table .positive {
            color: #1b5e20;
            font-weight: 600;
        }

        .data-table .negative {
            color: #c62828;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #999;
            background: #fafafa;
        }

        .empty-state i {
            font-size: 42px;
            margin-bottom: 12px;
            opacity: 0.4;
            color: #666;
        }

        /* 뱃지 */
        .badge-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 2px;
            font-size: 11px;
            font-weight: 700;
            border: 1px solid;
        }

        .badge-status.normal {
            background: white;
            color: #2e7d32;
            border-color: #2e7d32;
        }

        .badge-status.warning {
            background: #fff3e0;
            color: #e65100;
            border-color: #f57c00;
        }

        .badge-status.danger {
            background: #ffebee;
            color: #c62828;
            border-color: #c62828;
        }

        .category-badge {
            display: inline-block;
            padding: 2px 8px;
            border: 1px solid;
            border-radius: 2px;
            font-size: 11px;
            font-weight: 700;
        }

        .category-badge.물품 {
            background: white;
            color: #1565c0;
            border-color: #1976d2;
        }

        .category-badge.용역 {
            background: white;
            color: #6a1b9a;
            border-color: #7b1fa2;
        }

        .category-badge.공사 {
            background: white;
            color: #e65100;
            border-color: #f57c00;
        }

        /* 지출상태 뱃지 */
        .status-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 700;
            border: 1px solid;
        }

        .status-badge.계획 {
            background: #fff3e0;
            color: #e65100;
            border-color: #f57c00;
        }

        .status-badge.지출진행 {
            background: #e3f2fd;
            color: #1565c0;
            border-color: #1976d2;
        }

        .status-badge.지출완료 {
            background: #e8f5e9;
            color: #2e7d32;
            border-color: #388e3c;
        }

        /* 모달 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border: 3px solid #003876;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 18px 25px;
            background: #003876;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #002a56;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: white;
        }

        .modal-title::before {
            content: '▣ ';
            margin-right: 6px;
        }

        .modal-close {
            background: white;
            border: 1px solid white;
            font-size: 20px;
            color: #003876;
            cursor: pointer;
            padding: 2px 8px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .modal-close:hover {
            background: #f0f0f0;
        }

        .modal-body {
            padding: 25px;
            background: #fafafa;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 700;
            color: #111;
            font-size: 13px;
        }

        .form-label.required::after {
            content: ' *';
            color: #c62828;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 9px 12px;
            border: 1px solid #999;
            border-radius: 2px;
            font-size: 13px;
            background: white;
            transition: border-color 0.2s;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #003876;
            box-shadow: 0 0 0 2px rgba(0,56,118,0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 70px;
            font-family: '맑은 고딕', 'Malgun Gothic', sans-serif;
        }

        .modal-footer {
            padding: 15px 25px;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            background: white;
        }

        /* 서류 안내 - 공문서 스타일 */
        .doc-guide {
            background: #fffbf0;
            border: 2px solid #f57c00;
            padding: 18px;
            margin: 18px 0;
        }

        .doc-guide-title {
            font-weight: 700;
            color: #e65100;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
        }

        .doc-guide-title::before {
            content: '▶';
            font-size: 12px;
        }

        .doc-list {
            margin: 10px 0;
        }

        .doc-item {
            padding: 6px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .doc-item::before {
            content: '·';
            font-weight: 700;
            color: #003876;
        }

        .doc-section {
            margin: 12px 0;
            padding: 12px;
            background: white;
            border-left: 3px solid #003876;
        }

        .doc-section-title {
            font-weight: 700;
            color: #003876;
            margin-bottom: 8px;
            font-size: 13px;
        }

        /* 체크리스트 */
        .checklist {
            margin-top: 15px;
            background: white;
            padding: 15px;
            border: 1px solid #999;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
        }

        .checklist-item:last-child {
            border-bottom: none;
        }

        .checklist-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #003876;
        }

        .checklist-item label {
            flex: 1;
            cursor: pointer;
            font-size: 13px;
            color: #333;
        }

        .checklist-item input[type="checkbox"]:checked + label {
            color: #003876;
            font-weight: 700;
            text-decoration: underline;
        }

        /* 대분류 카드 */
        .main-cat-card {
            background: white;
            border: 2px solid #003876;
            padding: 20px;
            position: relative;
            transition: all 0.3s;
        }

        .main-cat-card:hover {
            box-shadow: 0 4px 12px rgba(0,56,118,0.2);
            transform: translateY(-2px);
        }

        .main-cat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #003876, #0066cc);
        }

        .main-cat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .main-cat-title {
            font-size: 16px;
            font-weight: 700;
            color: #003876;
        }

        .main-cat-count {
            font-size: 12px;
            color: #666;
            background: #f0f0f0;
            padding: 3px 10px;
            border-radius: 12px;
        }

        .main-cat-budget {
            margin-bottom: 12px;
        }

        .main-cat-budget-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 4px;
        }

        .main-cat-budget-value {
            font-size: 20px;
            font-weight: 700;
            color: #003876;
            font-family: 'Courier New', monospace;
        }

        .main-cat-progress {
            margin-top: 12px;
        }

        .main-cat-progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #666;
            margin-bottom: 6px;
        }

        .main-cat-progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .main-cat-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2e7d32, #66bb6a);
            transition: width 0.5s ease;
        }

        .main-cat-progress-fill.warning {
            background: linear-gradient(90deg, #f57c00, #ffb74d);
        }

        .main-cat-progress-fill.danger {
            background: linear-gradient(90deg, #c62828, #ef5350);
        }

        .main-cat-details {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e0e0e0;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 12px;
        }

        .main-cat-detail-item {
            display: flex;
            flex-direction: column;
        }

        .main-cat-detail-label {
            font-size: 10px;
            color: #999;
            margin-bottom: 2px;
        }

        .main-cat-detail-value {
            font-weight: 700;
            color: #333;
            font-family: 'Courier New', monospace;
        }

        /* 공문서 푸터 */
        .doc-footer {
            margin: 50px 40px 0 40px;
            padding: 30px 20px;
            border-top: 3px double #d0d0d0;
            text-align: center;
            color: #666;
            font-size: 12px;
            background: #fafafa;
        }

        .doc-footer p {
            margin: 5px 0;
        }

        /* 정부기관 하단바 */
        .gov-footer {
            background: #2c3e50;
            color: white;
            padding: 30px 0;
            margin-top: 40px;
        }

        .gov-footer-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 40px;
        }

        .gov-footer-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 15px;
            color: white;
        }

        .gov-footer-info {
            font-size: 12px;
            line-height: 2;
            color: #bdc3c7;
        }

        .gov-footer-info strong {
            color: white;
            margin-right: 5px;
        }

        /* 반응형 */
        @media print {
            .gov-top-bar,
            .gov-footer,
            .btn-group {
                display: none;
            }
            .modal {
                display: none !important;
            }
            .section {
                page-break-inside: avoid;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .system-header {
                padding: 20px 15px;
            }

            .header-top {
                flex-direction: column;
                gap: 10px;
            }

            .doc-info {
                text-align: left;
            }

            .stats-container {
                grid-template-columns: 1fr;
                padding: 15px;
            }

            .section-body {
                padding: 15px;
            }

            .data-table {
                font-size: 11px;
            }

            .data-table th,
            .data-table td {
                padding: 8px 4px;
            }
        }
    </style>
</head>
<body>

    <!-- 정부기관 상단 헤더 -->
    <div class="gov-header">
        <div class="gov-header-content">
            <div class="gov-header-left">
                <div class="gov-logo-area">
                    <div class="gov-logo-img">
                        <img src="logo.png" alt="국립공원 로고">
                    </div>
                    <div class="gov-org-name">국립공원공단 야생생물보전원 사육곰 보호센터</div>
                </div>
            </div>
            <div class="gov-header-right">
                <span id="currentDateTime"></span>
                <span id="currentUser" style="margin-left: 20px; font-weight: bold;"></span>
                <button onclick="logout()" style="margin-left: 10px; padding: 5px 10px; cursor: pointer; background: #003876; color: white; border: none; border-radius: 4px;">로그아웃</button>
            </div>
        </div>
    </div>

    <!-- 정부기관 네비게이션 바 -->
    <div class="gov-top-bar">
        <div class="gov-top-content">
            <div class="nav-title-full">
                <div class="nav-main-title">2025 예산 관리집행대장<span class="fiscal-year-nav">2025 회계연도</span></div>
                <div class="nav-subtitle">물품구매 · 용역계약 · 공사발주 통합관리</div>
            </div>
            <div class="nav-actions">
                <div class="nav-action-item" onclick="window.print()">
                    <i class="fas fa-print"></i>인쇄
                </div>
                <div class="nav-action-item" onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i>전체 다운로드
                </div>
                <div class="nav-action-item" onclick="exportSelectedToExcel()">
                    <i class="fas fa-check-square"></i>선택 다운로드
                </div>
            </div>
        </div>
    </div>

    <div class="container">

        <!-- 필터 영역 -->
        <div class="filter-section">
            <div class="filter-header">
                <h3><i class="fas fa-filter"></i> 필터</h3>
            </div>
            <div class="filter-body">
                <div class="filter-group">
                    <label class="filter-label">대분류</label>
                    <select id="filterMainCategory" class="filter-select" onchange="applyFilters()">
                        <option value="">전체</option>
                        <option value="인건비">인건비</option>
                        <option value="재료비">재료비</option>
                        <option value="경비">경비</option>
                        <option value="사무실조성">사무실조성</option>
                        <option value="진료실조성">진료실조성</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">지출상태</label>
                    <select id="filterStatus" class="filter-select" onchange="applyFilters()">
                        <option value="">전체</option>
                        <option value="계획">계획</option>
                        <option value="지출진행">지출진행</option>
                        <option value="지출완료">지출완료</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">구분</label>
                    <select id="filterType" class="filter-select" onchange="applyFilters()">
                        <option value="">전체</option>
                        <option value="물품">물품</option>
                        <option value="용역">용역</option>
                        <option value="공사">공사</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">지출일 (시작)</label>
                    <input type="date" id="filterDateStart" class="filter-input" onchange="applyFilters()">
                </div>
                <div class="filter-group">
                    <label class="filter-label">지출일 (종료)</label>
                    <input type="date" id="filterDateEnd" class="filter-input" onchange="applyFilters()">
                </div>
                <div class="filter-group">
                    <label class="filter-label">검색</label>
                    <input type="text" id="filterSearch" class="filter-input" placeholder="사업명 검색..." onkeyup="applyFilters()">
                </div>
                <div class="filter-group">
                    <button class="btn" onclick="resetFilters()">
                        <i class="fas fa-redo"></i> 초기화
                    </button>
                </div>
            </div>
        </div>

        <!-- 대분류별 예산 현황 테이블 -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">대분류별 예산 현황</h2>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="toggleAllCategories()">
                        <i class="fas fa-expand-alt"></i> 전체 펼치기/접기
                    </button>
                </div>
            </div>
            <div class="section-body">
                <div id="categoryBreakdownContainer"></div>
            </div>
        </div>

        <!-- 통계 카드 -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-label">총 편성 예산</div>
                <div class="stat-value" id="totalBudget">0원</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">지출완료 (집행완료)</div>
                <div class="stat-value" style="color: #2e7d32;" id="completedBudget">0원</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">지출진행 (진행중)</div>
                <div class="stat-value" style="color: #1565c0;" id="inProgressBudget">0원</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">계획 (미집행)</div>
                <div class="stat-value" style="color: #e65100;" id="plannedBudget">0원</div>
            </div>
        </div>

        <!-- 사업별 예산 현황 -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">사업별 예산 집행 현황</h2>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="openCategoryModal()">
                        <i class="fas fa-plus"></i> 사업 등록
                    </button>
                    <button class="btn btn-excel" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i> 엑셀 출력
                    </button>
                </div>
            </div>
            <div class="section-body">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 2%"><input type="checkbox" id="selectAllCategories" onchange="toggleAllCategorySelection()"></th>
                            <th style="width: 3%">연번</th>
                            <th style="width: 8%">대분류</th>
                            <th style="width: 6%">소분류</th>
                            <th style="width: 10%">사업명</th>
                            <th style="width: 5%">구분</th>
                            <th style="width: 8%">편성예산(원)</th>
                            <th style="width: 8%">집행액(원)</th>
                            <th style="width: 8%">잔액(원)</th>
                            <th style="width: 5%">집행률(%)</th>
                            <th style="width: 6%">지출상태</th>
                            <th style="width: 7%">지출일</th>
                            <th style="width: 24%">관리</th>
                        </tr>
                    </thead>
                    <tbody id="categoryTableBody">
                        <tr>
                            <td colspan="13" class="empty-state">
                                <i class="fas fa-folder-open"></i>
                                <p>등록된 사업이 없습니다.<br>상단 '사업 등록' 버튼을 클릭하거나 '초기 데이터 불러오기'를 이용하세요.</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 세부 품목 내역 -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">세부 품목별 집행 내역</h2>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="openItemModal()">
                        <i class="fas fa-plus"></i> 품목 등록
                    </button>
                    <button class="btn btn-danger" onclick="resetAllData()">
                        <i class="fas fa-trash-alt"></i> 전체 데이터 초기화
                    </button>
                </div>
            </div>
            <div class="section-body">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 2%"><input type="checkbox" id="selectAllItems" onchange="toggleAllItemSelection()"></th>
                            <th style="width: 3%">연번</th>
                            <th style="width: 11%">사업명</th>
                            <th style="width: 5%">구분</th>
                            <th style="width: 13%">품목명</th>
                            <th style="width: 11%">업체명</th>
                            <th style="width: 9%">연락처</th>
                            <th style="width: 8%">단가(원)</th>
                            <th style="width: 5%">수량</th>
                            <th style="width: 8%">합계(원)</th>
                            <th style="width: 8%">비고</th>
                            <th style="width: 17%">관리</th>
                        </tr>
                    </thead>
                    <tbody id="itemTableBody">
                        <tr>
                            <td colspan="12" class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <p>등록된 품목이 없습니다.</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- 로그인 모달 -->
    <div id="loginModal" class="modal" style="display: flex;">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header" style="background: #003876; color: white;">
                <h3 class="modal-title"><i class="fas fa-user-circle"></i> 예산 관리 시스템 접속</h3>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <div style="font-size: 16px; font-weight: bold; color: #003876; margin-bottom: 8px;">
                        국립공원공단 야생생물보전원
                    </div>
                    <div style="font-size: 14px; color: #666;">
                        사육곰 보호센터 예산관리대장
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label required">이름을 입력하세요</label>
                    <input type="text" id="loginName" class="form-input" placeholder="홍길동" autofocus style="font-size: 16px; padding: 12px;">
                </div>
                <div class="form-group">
                    <label class="form-label">소속부서 (선택)</label>
                    <select id="loginDepartment" class="form-select" style="font-size: 16px; padding: 12px;">
                        <option value="">▷ 선택하세요</option>
                        <option value="야생생물보전원">야생생물보전원</option>
                        <option value="사육곰보호센터">사육곰보호센터</option>
                        <option value="관리부서">관리부서</option>
                        <option value="기타">기타</option>
                    </select>
                </div>
                <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; font-size: 13px; color: #856404;">
                    <i class="fas fa-info-circle"></i> 입력하신 이름은 엑셀 다운로드 시 작성자로 기록됩니다.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="doLogin()" style="width: 100%; padding: 12px; font-size: 16px;">
                    <i class="fas fa-sign-in-alt"></i> 접속하기
                </button>
            </div>
        </div>
    </div>

    <!-- 사업 추가 모달 -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-folder-plus"></i> 사업 등록</h3>
                <button class="modal-close" onclick="closeCategoryModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label required">대분류 (카테고리)</label>
                    <select id="categoryMain" class="form-select" onchange="updateSubCategoryOptions()">
                        <option value="">▷ 선택하세요</option>
                        <option value="인건비">인건비 (69,000,000원)</option>
                        <option value="재료비">재료비 (10,000,000원)</option>
                        <option value="경비">경비 (139,000,000원)</option>
                        <option value="사무실조성">사무실조성 (100,000,000원)</option>
                        <option value="진료실조성">진료실조성(CT 포함) (540,000,000원)</option>
                    </select>
                    <input type="text" id="categoryMainCustom" class="form-input" placeholder="또는 새로운 대분류를 직접 입력하세요" style="margin-top: 8px;">
                </div>
                <div class="form-group" id="subCategoryGroup" style="display: none;">
                    <label class="form-label">소분류</label>
                    <select id="categorySub" class="form-select">
                        <option value="">▷ 선택하세요 (선택사항)</option>
                    </select>
                    <input type="text" id="categorySubCustom" class="form-input" placeholder="또는 새로운 소분류를 직접 입력하세요" style="margin-top: 8px;">
                </div>
                <div class="form-group">
                    <label class="form-label required">사업명</label>
                    <input type="text" id="categoryName" class="form-input" placeholder="예) 통신망 구축사업">
                </div>
                <div class="form-group">
                    <label class="form-label required">사업 구분</label>
                    <select id="categoryType" class="form-select">
                        <option value="">▷ 선택하세요</option>
                        <option value="물품">물품구매</option>
                        <option value="용역">용역계약</option>
                        <option value="공사">공사발주</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label required">편성예산 (원)</label>
                    <input type="number" id="categoryBudget" class="form-input" placeholder="10000000">
                </div>
                <div class="form-group">
                    <label class="form-label required">지출 상태</label>
                    <select id="categoryStatus" class="form-select">
                        <option value="">▷ 선택하세요</option>
                        <option value="계획">계획</option>
                        <option value="지출진행">지출진행</option>
                        <option value="지출완료">지출완료</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">지출일</label>
                    <input type="date" id="categoryPaymentDate" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">비고사항</label>
                    <textarea id="categoryNote" class="form-textarea" placeholder="사업 관련 참고사항을 입력하세요 (선택사항)"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeCategoryModal()"><i class="fas fa-times"></i> 취소</button>
                <button class="btn btn-primary" onclick="saveCategory()"><i class="fas fa-save"></i> 등록</button>
            </div>
        </div>
    </div>

    <!-- 품목 추가 모달 -->
    <div id="itemModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-box"></i> 품목 등록</h3>
                <button class="modal-close" onclick="closeItemModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label required">사업 선택</label>
                    <select id="itemCategory" class="form-select" onchange="updateDocGuide()">
                        <option value="">▷ 사업을 선택하세요</option>
                    </select>
                </div>

                <!-- 품목 리스트 -->
                <div id="itemsListContainer">
                    <div class="item-row" data-item-index="0">
                        <div style="display: grid; grid-template-columns: 2fr 1.5fr 1fr 1fr 1fr 2fr 40px; gap: 10px; margin-bottom: 10px; align-items: start;">
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label required">품목명</label>
                                <input type="text" class="form-input item-name" placeholder="예) 키폰 주장치 1식">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label">계약업체명</label>
                                <input type="text" class="form-input item-company" placeholder="예) (주)케이티">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label">연락처</label>
                                <input type="text" class="form-input item-phone" placeholder="02-1234-5678">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label required">단가</label>
                                <input type="number" class="form-input item-price" placeholder="1800000">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label required">수량</label>
                                <input type="number" class="form-input item-quantity" value="1" min="1">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label">비고</label>
                                <input type="text" class="form-input item-note" placeholder="특이사항">
                            </div>
                            <div style="padding-top: 28px;">
                                <button class="btn btn-sm" onclick="removeItemRow(this)" style="padding: 8px; background: #f44336; color: white; border: none; cursor: pointer; border-radius: 4px;" title="삭제">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin: 15px 0;">
                    <button class="btn btn-primary" onclick="addItemRow()" style="width: 100%;">
                        <i class="fas fa-plus"></i> 품목 추가
                    </button>
                </div>

                <!-- 필요 서류 안내 -->
                <div id="docGuideContainer"></div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeItemModal()"><i class="fas fa-times"></i> 취소</button>
                <button class="btn btn-success" onclick="saveBulkItems()"><i class="fas fa-save"></i> 일괄 등록</button>
            </div>
        </div>
    </div>

    <!-- 서류 확인 모달 -->
    <div id="docModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-file-alt"></i> 구비서류 제출 현황</h3>
                <button class="modal-close" onclick="closeDocModal()">×</button>
            </div>
            <div class="modal-body" id="docModalBody">
                <!-- 동적으로 생성됨 -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeDocModal()"><i class="fas fa-check"></i> 확인</button>
            </div>
        </div>
    </div>

    <script>
        // 현재 날짜 및 시간 표시
        function updateDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const date = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');

            const dateTimeStr = `${year}.${month}.${date} ${hours}:${minutes}`;
            const element = document.getElementById('currentDateTime');
            if (element) {
                element.textContent = dateTimeStr;
            }
        }

        // 1분마다 시간 업데이트
        updateDateTime();
        setInterval(updateDateTime, 60000);

        const today = new Date();

        // 데이터 구조
        let budgetData = {
            categories: {} // {사업명: {type: 구분, budget: 예산, note: 비고, mainCategory: 대분류, subCategory: 소분류, status: 지출상태, paymentDate: 지출일, items: []}}
        };

        // 사용자 정보
        let currentUserInfo = {
            name: '',
            department: '',
            loginTime: null
        };

        // 로그인 함수
        function doLogin() {
            const name = document.getElementById('loginName').value.trim();
            const department = document.getElementById('loginDepartment').value;

            if (!name) {
                alert('이름을 입력해주세요.');
                document.getElementById('loginName').focus();
                return;
            }

            // 사용자 정보 저장
            currentUserInfo.name = name;
            currentUserInfo.department = department || '미지정';
            currentUserInfo.loginTime = new Date();

            // localStorage에 저장
            localStorage.setItem('userInfo', JSON.stringify(currentUserInfo));

            // 헤더에 이름 표시
            updateUserDisplay();

            // 로그인 모달 닫기
            document.getElementById('loginModal').style.display = 'none';

            // 데이터 로드
            loadData();
        }

        // 로그아웃 함수
        function logout() {
            if (confirm('로그아웃 하시겠습니까?')) {
                localStorage.removeItem('userInfo');
                currentUserInfo = { name: '', department: '', loginTime: null };
                document.getElementById('loginModal').style.display = 'flex';
                document.getElementById('currentUser').textContent = '';
            }
        }

        // 사용자 정보 표시
        function updateUserDisplay() {
            const userElement = document.getElementById('currentUser');
            if (currentUserInfo.name) {
                const deptText = currentUserInfo.department !== '미지정' ? ` (${currentUserInfo.department})` : '';
                userElement.innerHTML = `<i class="fas fa-user"></i> ${currentUserInfo.name}${deptText}`;
            }
        }

        // 페이지 로드 시 로그인 체크
        function checkLogin() {
            const savedUser = localStorage.getItem('userInfo');
            if (savedUser) {
                currentUserInfo = JSON.parse(savedUser);
                updateUserDisplay();
                document.getElementById('loginModal').style.display = 'none';
                loadData();
            } else {
                document.getElementById('loginModal').style.display = 'flex';
            }
        }

        // 엔터키로 로그인
        document.addEventListener('DOMContentLoaded', function() {
            const loginInput = document.getElementById('loginName');
            if (loginInput) {
                loginInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        doLogin();
                    }
                });
            }
        });

        // API 기본 URL
        // 로컬 개발: http://localhost:3000/api
        // Netlify 배포: /.netlify/functions/api
        const API_BASE_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:3000/api'
            : '/.netlify/functions/api';

        // 대분류별 소분류 정의
        const subCategories = {
            '재료비': ['먹이비', '사료', '과일', '채소', '육류', '기타 재료'],
            '경비': ['공공요금', '통신비', '운영비', '유지보수비', '기타 경비'],
            '인건비': ['급여', '상여금', '퇴직금', '4대보험', '복리후생비'],
            '사무실조성': ['통신망', '정보기기', '가구', '안전설비', '기타 비품'],
            '진료실조성': ['대형의료장비', '시설 인프라', '수술실장비', '수납 보관시설', '진단검사장비']
        };

        // 대분류별 할당 예산
        const mainCategoryBudgets = {
            '인건비': 69000000,
            '재료비': 10000000,
            '경비': 139000000,
            '사무실조성': 100000000,
            '진료실조성': 540000000
        };

        // 소분류 옵션 업데이트
        function updateSubCategoryOptions() {
            const mainSelect = document.getElementById('categoryMain').value;
            const subSelect = document.getElementById('categorySub');
            const subGroup = document.getElementById('subCategoryGroup');

            subSelect.innerHTML = '<option value="">▷ 선택하세요 (선택사항)</option>';

            if (mainSelect && subCategories[mainSelect]) {
                subGroup.style.display = 'block';
                subCategories[mainSelect].forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    subSelect.appendChild(option);
                });
            } else {
                subGroup.style.display = 'none';
            }
        }

        // 필요 서류 규칙
        function getRequiredDocuments(categoryType, amount) {
            // 100만원 미만인 경우 간소화된 서류만 요구
            if (amount < 1000000) {
                return {
                    시행결의: ['견적서'],
                    결과보고서: ['물납조서'],
                    지출: ['지출증빙 영수증']
                };
            }

            // 100만원 이상인 경우 기존 규칙 적용
            const docs = {
                시행결의: ['견적서'],
                결과보고서: [],
                지출: ['사업자등록증', '전자세금계산서', '통장사본']
            };

            // 물품인 경우 물납조서 추가
            if (categoryType === '물품') {
                docs.결과보고서.push('물납조서');
            }

            // 공사인 경우 안전보건관리계획서 추가
            if (categoryType === '공사') {
                docs.시행결의.push('안전보건관리계획서');
            }

            // 100만원 이상인 경우 승낙서 추가
            docs.지출.push('승낙서');

            return docs;
        }

        // 서류 안내 업데이트
        function updateDocGuide() {
            const categoryName = document.getElementById('itemCategory').value;
            const price = parseInt(document.getElementById('itemPrice').value) || 0;
            const quantity = parseInt(document.getElementById('itemQuantity').value) || 1;
            const container = document.getElementById('docGuideContainer');
            const checklistContainer = document.getElementById('docChecklist');
            const checklistGroup = document.getElementById('checklistGroup');

            if (!categoryName || !price) {
                container.innerHTML = '';
                checklistContainer.innerHTML = '';
                checklistGroup.style.display = 'none';
                return;
            }

            const category = budgetData.categories[categoryName];
            if (!category) return;

            const totalAmount = price * quantity;
            const docs = getRequiredDocuments(category.type, totalAmount);

            let html = `
                <div class="doc-guide">
                    <div class="doc-guide-title">
                        구비서류 안내 (총액: ${totalAmount.toLocaleString()}원)
                    </div>
            `;

            for (const [stage, docList] of Object.entries(docs)) {
                if (docList.length > 0) {
                    html += `
                        <div class="doc-section">
                            <div class="doc-section-title">[${stage}]</div>
                            <div class="doc-list">
                    `;
                    docList.forEach(doc => {
                        html += `<div class="doc-item">${doc}</div>`;
                    });
                    html += `</div></div>`;
                }
            }

            html += `</div>`;
            container.innerHTML = html;

            // 체크리스트 생성
            let checklistHtml = '';
            const allDocs = [...docs.시행결의, ...docs.결과보고서, ...docs.지출];
            allDocs.forEach((doc, index) => {
                checklistHtml += `
                    <div class="checklist-item">
                        <input type="checkbox" id="doc_${index}" data-doc="${doc}">
                        <label for="doc_${index}">${doc}</label>
                    </div>
                `;
            });
            checklistContainer.innerHTML = checklistHtml;
            checklistGroup.style.display = 'block';
        }

        // 숫자 포맷팅
        function formatNumber(num) {
            return num.toLocaleString('ko-KR');
        }

        // 날짜 포맷팅
        function formatDate(dateString) {
            const date = new Date(dateString);
            return `${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getDate()).padStart(2, '0')}`;
        }

        // 데이터 로드 (API에서)
        async function loadData() {
            try {
                const response = await fetch(`${API_BASE_URL}/categories`);
                if (!response.ok) throw new Error('데이터 로드 실패');

                const categories = await response.json();

                // API 데이터를 budgetData 형식으로 변환
                budgetData.categories = {};
                categories.forEach(cat => {
                    budgetData.categories[cat.name] = {
                        id: cat.id,
                        name: cat.name,
                        type: cat.type,
                        budget: Number(cat.budget),
                        note: cat.note,
                        mainCategory: cat.main_category,
                        subCategory: cat.sub_category,
                        status: cat.status,
                        paymentDate: cat.payment_date,
                        items: cat.items ? cat.items.filter(item => item !== null).map(item => ({
                            id: item.id,
                            name: item.name,
                            company: item.company,
                            phone: item.phone,
                            price: Number(item.price),
                            quantity: Number(item.quantity),
                            note: item.note,
                            checkedDocs: item.checked_docs || []
                        })) : []
                    };
                });

                renderAll();
            } catch (error) {
                console.error('데이터 로드 오류:', error);
                alert('데이터를 불러오는 중 오류가 발생했습니다.');
            }
        }

        // 데이터 저장 (API로)
        async function saveData() {
            // API를 사용하므로 별도 저장 불필요
            // 개별 작업(추가/수정/삭제)에서 API 호출
        }

        // 전체 렌더링
        function renderAll() {
            renderCategoryBreakdown();
            renderStats();
            renderCategoryTable();
            renderItemTable();
            updateCategorySelect();
        }

        // 대분류별 예산 현황 렌더링
        function renderCategoryBreakdown() {
            const container = document.getElementById('categoryBreakdownContainer');
            container.innerHTML = '';

            // 필터링된 데이터 가져오기
            const filteredData = getFilteredCategories();

            // 대분류별로 그룹화
            const grouped = {};
            for (const [name, data] of Object.entries(filteredData)) {
                const mainCat = data.mainCategory || '미분류';
                if (!grouped[mainCat]) {
                    grouped[mainCat] = [];
                }
                grouped[mainCat].push({ name, ...data });
            }

            // 대분류별로 렌더링 (할당 예산 기준으로 정렬)
            const sortedCategories = Object.keys(mainCategoryBudgets);

            for (const mainCat of sortedCategories) {
                const items = grouped[mainCat] || [];

                // 할당 예산 (고정값)
                const allocatedBudget = mainCategoryBudgets[mainCat] || 0;

                // 사용액 계산 (지출완료된 항목만)
                let usedBudget = 0;
                items.forEach(item => {
                    if (item.status === '지출완료' || item.status === '진행중') {
                        // 품목이 있으면 품목 합계, 없으면 예산액
                        const itemTotal = item.items.reduce((sum, subItem) => sum + (subItem.price * subItem.quantity), 0);
                        usedBudget += itemTotal > 0 ? itemTotal : item.budget;
                    }
                });

                // 잔액 계산
                const remaining = allocatedBudget - usedBudget;
                const usageRate = allocatedBudget > 0 ? ((usedBudget / allocatedBudget) * 100).toFixed(1) : 0;

                // 카테고리 박스 생성
                const breakdownDiv = document.createElement('div');
                breakdownDiv.className = 'category-breakdown';
                breakdownDiv.innerHTML = `
                    <div class="breakdown-header" onclick="toggleBreakdown('${mainCat}')">
                        <div class="breakdown-header-left">
                            <div class="breakdown-category-name">${mainCat}</div>
                            <div class="breakdown-budget-info">
                                <span class="breakdown-label">총 예산:</span> <span class="breakdown-total">${formatNumber(allocatedBudget)}원</span>
                                <span class="breakdown-separator">|</span>
                                <span class="breakdown-label">사용:</span> <span class="breakdown-used">${formatNumber(usedBudget)}원</span>
                                <span class="breakdown-separator">|</span>
                                <span class="breakdown-label">잔액:</span> <span class="breakdown-remaining ${remaining < 0 ? 'negative' : 'positive'}">${formatNumber(remaining)}원</span>
                                <span class="breakdown-separator">|</span>
                                <span class="breakdown-label">집행률:</span> <span class="breakdown-rate" style="color: ${usageRate >= 100 ? '#c62828' : usageRate >= 80 ? '#f57c00' : '#2e7d32'};">${usageRate}%</span>
                            </div>
                        </div>
                        <i class="fas fa-chevron-down breakdown-toggle" id="toggle-${mainCat}"></i>
                    </div>
                    <div class="breakdown-body" id="body-${mainCat}">
                        <table class="breakdown-table">
                            <thead>
                                <tr>
                                    <th style="width: 20%">사업명</th>
                                    <th style="width: 15%">예산액</th>
                                    <th style="width: 65%">세부 내역</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.map(item => {
                                    // 세부 품목 리스트 생성
                                    let detailsHtml = '';
                                    if (item.items && item.items.length > 0) {
                                        detailsHtml = '<ul class="breakdown-item-details">';
                                        item.items.forEach(subItem => {
                                            const itemTotal = subItem.price * subItem.quantity;
                                            detailsHtml += `<li>- ${subItem.name} ${formatNumber(itemTotal)}원`;
                                            if (subItem.quantity > 1) {
                                                detailsHtml += ` (${formatNumber(subItem.price)}원 × ${subItem.quantity}개)`;
                                            }
                                            if (subItem.company) {
                                                detailsHtml += ` [${subItem.company}]`;
                                            }
                                            detailsHtml += '</li>';
                                        });
                                        detailsHtml += '</ul>';
                                    } else {
                                        detailsHtml = '<div class="breakdown-item-details">- 세부 품목 미등록</div>';
                                    }

                                    return `
                                        <tr>
                                            <td><div class="breakdown-item-name">${item.name}</div></td>
                                            <td style="text-align: right; font-weight: 600; font-family: 'Courier New', monospace;">${formatNumber(item.budget || 0)}원</td>
                                            <td>${detailsHtml}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                container.appendChild(breakdownDiv);
            }
        }

        // 개별 카테고리 토글
        function toggleBreakdown(category) {
            const body = document.getElementById(`body-${category}`);
            const toggle = document.getElementById(`toggle-${category}`);

            if (body.classList.contains('expanded')) {
                body.classList.remove('expanded');
                toggle.classList.remove('expanded');
            } else {
                body.classList.add('expanded');
                toggle.classList.add('expanded');
            }
        }

        // 전체 펼치기/접기
        let allExpanded = false;
        function toggleAllCategories() {
            const bodies = document.querySelectorAll('.breakdown-body');
            const toggles = document.querySelectorAll('.breakdown-toggle');

            if (allExpanded) {
                bodies.forEach(body => body.classList.remove('expanded'));
                toggles.forEach(toggle => toggle.classList.remove('expanded'));
            } else {
                bodies.forEach(body => body.classList.add('expanded'));
                toggles.forEach(toggle => toggle.classList.add('expanded'));
            }

            allExpanded = !allExpanded;
        }

        // 통계 렌더링
        function renderStats() {
            // 총 할당 예산 (고정값)
            const totalAllocated = Object.values(mainCategoryBudgets).reduce((sum, val) => sum + val, 0);

            let completedBudget = 0;  // 지출완료 (실제 사용액)
            let inProgressBudget = 0; // 지출진행 예산
            let plannedBudget = 0;    // 계획 예산

            for (const [name, data] of Object.entries(budgetData.categories)) {
                const budget = data.budget || 0;
                const status = data.status || '계획';

                // 각 상태별로 예산 분류
                if (status === '지출완료' || status === '진행중') {
                    // 지출완료, 진행중은 실제 집행액으로 계산
                    const used = data.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                    completedBudget += used > 0 ? used : budget;
                } else if (status === '지출진행') {
                    inProgressBudget += budget;
                } else if (status === '계획') {
                    plannedBudget += budget;
                }
            }

            document.getElementById('totalBudget').textContent = formatNumber(totalAllocated) + '원';
            document.getElementById('completedBudget').textContent = formatNumber(completedBudget) + '원';
            document.getElementById('inProgressBudget').textContent = formatNumber(inProgressBudget) + '원';
            document.getElementById('plannedBudget').textContent = formatNumber(plannedBudget) + '원';
        }

        // 카테고리 테이블 렌더링
        function renderCategoryTable() {
            const tbody = document.getElementById('categoryTableBody');
            tbody.innerHTML = '';

            // 필터링된 데이터 사용
            const filteredData = getFilteredCategories();
            const categories = Object.entries(filteredData);

            if (categories.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="14" class="empty-state">
                            <i class="fas fa-folder-open"></i>
                            <p>등록된 사업이 없습니다.<br>상단 '사업 등록' 버튼을 클릭하거나 '초기 데이터 불러오기'를 이용하세요.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            // 대분류별로 그룹화
            const grouped = {};
            categories.forEach(([name, data]) => {
                const mainCat = data.mainCategory || '미분류';
                if (!grouped[mainCat]) {
                    grouped[mainCat] = [];
                }
                grouped[mainCat].push([name, data]);
            });

            // 대분류별로 렌더링
            let globalIndex = 1;
            for (const [mainCat, items] of Object.entries(grouped)) {
                // 대분류별 합계 계산
                let mainBudget = 0;
                let mainUsed = 0;
                items.forEach(([name, data]) => {
                    mainBudget += data.budget;
                    // 진행중, 지출완료인 경우 사용액으로 계산
                    if (data.status === '지출완료' || data.status === '진행중') {
                        mainUsed += data.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                    }
                });
                const mainRemaining = mainBudget - mainUsed;
                const mainRate = mainBudget > 0 ? ((mainUsed / mainBudget) * 100).toFixed(1) : 0;

                // 대분류 헤더
                const headerRow = document.createElement('tr');
                headerRow.style.background = 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)';
                headerRow.style.fontWeight = '700';
                headerRow.style.borderTop = '2px solid #003876';
                headerRow.style.borderBottom = '2px solid #003876';
                headerRow.innerHTML = `
                    <td style="background: rgba(255,255,255,0.5);"></td>
                    <td colspan="3" class="text-left" style="padding: 14px 12px; color: #003876; font-size: 15px; font-weight: 700;">
                        <i class="fas fa-folder" style="margin-right: 8px;"></i>${mainCat}
                    </td>
                    <td class="text-right" style="color: #003876; font-size: 13px;">총 ${items.length}개 사업</td>
                    <td style="background: rgba(255,255,255,0.5);"></td>
                    <td class="text-right amount" style="color: #003876; font-size: 14px; background: rgba(255,255,255,0.5);">${formatNumber(mainBudget)}</td>
                    <td class="text-right amount" style="color: #1565c0; font-size: 14px; background: rgba(255,255,255,0.5);">${formatNumber(mainUsed)}</td>
                    <td class="text-right ${mainRemaining >= 0 ? 'positive' : 'negative'}" style="font-size: 14px; background: rgba(255,255,255,0.5);">${formatNumber(mainRemaining)}</td>
                    <td style="color: ${mainRate >= 100 ? '#c62828' : mainRate >= 80 ? '#f57c00' : '#2e7d32'}; font-size: 14px; font-weight: 700; background: rgba(255,255,255,0.5);">${mainRate}%</td>
                    <td colspan="3" style="background: rgba(255,255,255,0.5);"></td>
                `;
                tbody.appendChild(headerRow);

                // 세부 사업
                items.forEach(([name, data]) => {
                    // 진행중, 지출완료인 경우 사용액으로 계산
                    let used = 0;
                    if (data.status === '지출완료' || data.status === '진행중') {
                        used = data.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                    }
                    const remaining = data.budget - used;
                    const rate = data.budget > 0 ? ((used / data.budget) * 100).toFixed(1) : 0;

                    let statusBadge = '';

                    const row = document.createElement('tr');
                    const paymentStatus = data.status || '계획';
                    const escapedName = name.replace(/'/g, "\\'");
                    const paymentDate = data.paymentDate ? formatDate(data.paymentDate) : '-';
                    row.innerHTML = `
                        <td><input type="checkbox" class="category-checkbox" data-category="${escapedName}"></td>
                        <td>${globalIndex++}</td>
                        <td class="text-left editable-cell" style="padding-left: 20px; color: #666; font-size: 12px;" data-field="mainCategory" data-category="${escapedName}" ondblclick="makeCellEditable(this, 'category', '${escapedName}')">└ ${mainCat}</td>
                        <td class="text-left editable-cell" style="color: #888; font-size: 12px;" data-field="subCategory" data-category="${escapedName}" ondblclick="makeCellEditable(this, 'category', '${escapedName}')">${data.subCategory ? data.subCategory : '-'}</td>
                        <td class="text-left editable-cell" data-field="name" data-category="${escapedName}" ondblclick="makeCellEditable(this, 'category', '${escapedName}')">${name}</td>
                        <td class="editable-cell" data-field="type" data-category="${escapedName}" ondblclick="makeCellEditable(this, 'category', '${escapedName}')"><span class="category-badge ${data.type}">${data.type}</span></td>
                        <td class="text-right amount editable-cell" data-field="budget" data-category="${escapedName}" ondblclick="makeCellEditable(this, 'category', '${escapedName}')">${formatNumber(data.budget)}</td>
                        <td class="text-right amount">${formatNumber(used)}</td>
                        <td class="text-right ${remaining >= 0 ? 'positive' : 'negative'}">${formatNumber(remaining)}</td>
                        <td>${rate}%</td>
                        <td class="editable-cell" data-field="status" data-category="${escapedName}" ondblclick="makeCellEditable(this, 'category', '${escapedName}')"><span class="status-badge ${paymentStatus}">${paymentStatus}</span></td>
                        <td style="font-size: 12px;" class="editable-cell" data-field="paymentDate" data-category="${escapedName}" ondblclick="makeCellEditable(this, 'category', '${escapedName}')">${paymentDate}</td>
                        <td>
                            <button class="btn btn-success btn-sm" onclick="viewCategoryDocs('${escapedName}')">
                                서류확인
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteCategory('${escapedName}')">
                                삭제
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        // 품목 테이블 렌더링
        function renderItemTable() {
            const tbody = document.getElementById('itemTableBody');
            tbody.innerHTML = '';

            // 필터링된 데이터에서 품목 그룹화
            const filteredData = getFilteredCategories();
            const groupedByMain = {};
            for (const [categoryName, data] of Object.entries(filteredData)) {
                const mainCat = data.mainCategory || '미분류';
                if (!groupedByMain[mainCat]) {
                    groupedByMain[mainCat] = [];
                }
                data.items.forEach((item) => {
                    groupedByMain[mainCat].push({
                        category: categoryName,
                        categoryType: data.type,
                        itemId: item.id,
                        mainCategory: mainCat,
                        ...item
                    });
                });
            }

            // 전체 품목이 없으면
            let totalItems = 0;
            for (const items of Object.values(groupedByMain)) {
                totalItems += items.length;
            }

            if (totalItems === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>등록된 품목이 없습니다.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            // 대분류별로 렌더링
            let globalIndex = 1;
            for (const [mainCat, items] of Object.entries(groupedByMain)) {
                // 대분류 헤더
                const headerRow = document.createElement('tr');
                headerRow.style.background = 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)';
                headerRow.style.borderTop = '2px solid #f57c00';
                headerRow.style.borderBottom = '1px solid #f57c00';
                headerRow.innerHTML = `
                    <td colspan="12" class="text-left" style="padding: 12px; color: #e65100; font-size: 14px; font-weight: 700;">
                        <i class="fas fa-folder-open" style="margin-right: 8px;"></i>${mainCat} (${items.length}개 품목)
                    </td>
                `;
                tbody.appendChild(headerRow);

                // 품목들
                items.forEach((item) => {
                    const total = item.price * item.quantity;
                    const row = document.createElement('tr');
                    const escapedCategory = item.category.replace(/'/g, "\\'");
                    row.innerHTML = `
                        <td><input type="checkbox" class="item-checkbox" data-item-id="${item.itemId}"></td>
                        <td>${globalIndex++}</td>
                        <td class="text-left">${item.category}</td>
                        <td><span class="category-badge ${item.categoryType}">${item.categoryType}</span></td>
                        <td class="text-left editable-cell" data-field="name" data-item-id="${item.itemId}" ondblclick="makeCellEditable(this, 'item', ${item.itemId})">${item.name}</td>
                        <td class="text-left editable-cell" data-field="company" data-item-id="${item.itemId}" ondblclick="makeCellEditable(this, 'item', ${item.itemId})">${item.company || '-'}</td>
                        <td class="editable-cell" data-field="phone" data-item-id="${item.itemId}" ondblclick="makeCellEditable(this, 'item', ${item.itemId})">${item.phone || '-'}</td>
                        <td class="text-right editable-cell" data-field="price" data-item-id="${item.itemId}" ondblclick="makeCellEditable(this, 'item', ${item.itemId})">${formatNumber(item.price)}</td>
                        <td class="editable-cell" data-field="quantity" data-item-id="${item.itemId}" ondblclick="makeCellEditable(this, 'item', ${item.itemId})">${item.quantity}</td>
                        <td class="text-right amount">${formatNumber(total)}</td>
                        <td class="text-left editable-cell" data-field="note" data-item-id="${item.itemId}" ondblclick="makeCellEditable(this, 'item', ${item.itemId})">${item.note || '-'}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteItem('${escapedCategory}', ${item.itemId})">
                                삭제
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        // 카테고리 선택 업데이트
        function updateCategorySelect() {
            const select = document.getElementById('itemCategory');
            select.innerHTML = '<option value="">▷ 사업을 선택하세요</option>';

            for (const [name, data] of Object.entries(budgetData.categories)) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = `${name} (${data.type})`;
                select.appendChild(option);
            }
        }

        // 카테고리 모달
        let editingCategoryId = null;

        function openCategoryModal() {
            // 새로 만들기 모드로 설정
            editingCategoryId = null;

            document.getElementById('categoryModal').classList.add('active');
            document.getElementById('categoryMain').value = '';
            document.getElementById('categoryMainCustom').value = '';
            document.getElementById('categorySub').value = '';
            document.getElementById('categorySubCustom').value = '';
            document.getElementById('subCategoryGroup').style.display = 'none';
            document.getElementById('categoryName').value = '';
            document.getElementById('categoryType').value = '';
            document.getElementById('categoryBudget').value = '';
            document.getElementById('categoryStatus').value = '';
            document.getElementById('categoryPaymentDate').value = '';
            document.getElementById('categoryNote').value = '';

            // 버튼 텍스트 초기화
            const saveBtn = document.querySelector('#categoryModal .btn-primary');
            if (saveBtn) {
                saveBtn.textContent = '등록';
            }
        }

        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('active');
        }

        async function saveCategory() {
            const mainSelect = document.getElementById('categoryMain').value;
            const mainCustom = document.getElementById('categoryMainCustom').value.trim();
            const mainCategory = mainCustom || mainSelect;

            const subSelect = document.getElementById('categorySub').value;
            const subCustom = document.getElementById('categorySubCustom').value.trim();
            const subCategory = subCustom || subSelect;

            const name = document.getElementById('categoryName').value.trim();
            const type = document.getElementById('categoryType').value;
            const budget = parseInt(document.getElementById('categoryBudget').value) || 0;
            const status = document.getElementById('categoryStatus').value;
            const paymentDate = document.getElementById('categoryPaymentDate').value;
            const note = document.getElementById('categoryNote').value.trim();

            if (!mainCategory) {
                alert('대분류를 선택하거나 입력하세요.');
                return;
            }

            if (!name) {
                alert('사업명을 입력하세요.');
                return;
            }

            if (!type) {
                alert('사업 구분을 선택하세요.');
                return;
            }

            if (budget <= 0) {
                alert('올바른 예산액을 입력하세요.');
                return;
            }

            if (!status) {
                alert('지출 상태를 선택하세요.');
                return;
            }

            try {
                const categoryData = {
                    name: name,
                    mainCategory: mainCategory,
                    subCategory: subCategory,
                    type: type,
                    budget: budget,
                    status: status,
                    paymentDate: paymentDate || null,
                    note: note
                };

                // 수정 모드인지 확인
                const isEdit = editingCategoryId !== null;
                const url = isEdit
                    ? `${API_BASE_URL}/categories/${editingCategoryId}`
                    : `${API_BASE_URL}/categories`;
                const method = isEdit ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(categoryData)
                });

                if (!response.ok) throw new Error('저장 실패');

                // 수정 모드 초기화
                editingCategoryId = null;

                await loadData();
                closeCategoryModal();
            } catch (error) {
                console.error('카테고리 저장 오류:', error);
                alert('저장 중 오류가 발생했습니다.');
            }
        }

        async function editCategory(name) {
            const category = budgetData.categories[name];
            if (!category) {
                alert('카테고리를 찾을 수 없습니다.');
                return;
            }

            // 수정 모드로 설정
            editingCategoryId = category.id;

            // 모달 열기
            document.getElementById('categoryModal').classList.add('active');

            // 기존 데이터 채우기
            const mainCustomInput = document.getElementById('categoryMainCustom');
            const mainSelect = document.getElementById('categoryMain');

            // 대분류 설정
            if (mainSelect.querySelector(`option[value="${category.mainCategory}"]`)) {
                mainSelect.value = category.mainCategory;
                mainCustomInput.value = '';
            } else {
                mainSelect.value = '직접입력';
                mainCustomInput.value = category.mainCategory;
            }

            // 중분류 설정
            if (category.subCategory) {
                updateSubCategoryOptions();
                const subSelect = document.getElementById('categorySub');
                const subCustomInput = document.getElementById('categorySubCustom');

                if (subSelect.querySelector(`option[value="${category.subCategory}"]`)) {
                    subSelect.value = category.subCategory;
                    subCustomInput.value = '';
                } else {
                    subSelect.value = '직접입력';
                    subCustomInput.value = category.subCategory;
                }
            }

            document.getElementById('categoryName').value = category.name;
            document.getElementById('categoryType').value = category.type;
            document.getElementById('categoryBudget').value = category.budget;
            document.getElementById('categoryStatus').value = category.status;
            document.getElementById('categoryPaymentDate').value = category.paymentDate || '';
            document.getElementById('categoryNote').value = category.note || '';

            // 버튼 텍스트 변경
            const saveBtn = document.querySelector('#categoryModal .btn-primary');
            if (saveBtn) {
                saveBtn.textContent = '수정';
            }
        }

        async function deleteCategory(name) {
            if (!confirm(`'${name}' 사업을 삭제하시겠습니까?\n※ 등록된 모든 품목도 함께 삭제됩니다.`)) {
                return;
            }

            try {
                const category = budgetData.categories[name];
                const response = await fetch(`${API_BASE_URL}/categories/${category.id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('삭제 실패');

                await loadData();
            } catch (error) {
                console.error('카테고리 삭제 오류:', error);
                alert('삭제 중 오류가 발생했습니다.');
            }
        }

        // 품목 모달
        let editingItemId = null;
        let editingItemCategoryId = null;

        function openItemModal() {
            if (Object.keys(budgetData.categories).length === 0) {
                alert('먼저 사업을 등록해주세요.');
                return;
            }

            // 새로 만들기 모드로 설정
            editingItemId = null;
            editingItemCategoryId = null;

            document.getElementById('itemModal').classList.add('active');
            document.getElementById('itemCategory').value = '';
            document.getElementById('itemName').value = '';
            document.getElementById('itemCompany').value = '';
            document.getElementById('itemPhone').value = '';
            document.getElementById('itemPrice').value = '';
            document.getElementById('itemQuantity').value = '1';
            document.getElementById('itemNote').value = '';
            document.getElementById('docGuideContainer').innerHTML = '';
            document.getElementById('docChecklist').innerHTML = '';
            document.getElementById('checklistGroup').style.display = 'none';

            // 버튼 텍스트 초기화
            const saveBtn = document.querySelector('#itemModal .btn-primary');
            if (saveBtn) {
                saveBtn.textContent = '등록';
            }
        }

        function closeItemModal() {
            document.getElementById('itemModal').classList.remove('active');
            // 품목 리스트 초기화
            resetItemsList();
        }

        // 품목 행 추가
        function addItemRow() {
            const container = document.getElementById('itemsListContainer');
            const index = container.children.length;

            const rowHtml = `
                <div class="item-row" data-item-index="${index}">
                    <div style="display: grid; grid-template-columns: 2fr 1.5fr 1fr 1fr 1fr 2fr 40px; gap: 10px; margin-bottom: 10px; align-items: start;">
                        <div class="form-group" style="margin: 0;">
                            <input type="text" class="form-input item-name" placeholder="예) 키폰 주장치 1식">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <input type="text" class="form-input item-company" placeholder="예) (주)케이티">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <input type="text" class="form-input item-phone" placeholder="02-1234-5678">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <input type="number" class="form-input item-price" placeholder="1800000">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <input type="number" class="form-input item-quantity" value="1" min="1">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <input type="text" class="form-input item-note" placeholder="특이사항">
                        </div>
                        <div style="padding-top: 0;">
                            <button class="btn btn-sm" onclick="removeItemRow(this)" style="padding: 8px; background: #f44336; color: white; border: none; cursor: pointer; border-radius: 4px;" title="삭제">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', rowHtml);
        }

        // 품목 행 삭제
        function removeItemRow(button) {
            const container = document.getElementById('itemsListContainer');
            if (container.children.length <= 1) {
                alert('최소 1개의 품목은 있어야 합니다.');
                return;
            }
            button.closest('.item-row').remove();
        }

        // 품목 리스트 초기화
        function resetItemsList() {
            const container = document.getElementById('itemsListContainer');
            container.innerHTML = `
                <div class="item-row" data-item-index="0">
                    <div style="display: grid; grid-template-columns: 2fr 1.5fr 1fr 1fr 1fr 2fr 40px; gap: 10px; margin-bottom: 10px; align-items: start;">
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label required">품목명</label>
                            <input type="text" class="form-input item-name" placeholder="예) 키폰 주장치 1식">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">계약업체명</label>
                            <input type="text" class="form-input item-company" placeholder="예) (주)케이티">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">연락처</label>
                            <input type="text" class="form-input item-phone" placeholder="02-1234-5678">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label required">단가</label>
                            <input type="number" class="form-input item-price" placeholder="1800000">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label required">수량</label>
                            <input type="number" class="form-input item-quantity" value="1" min="1">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">비고</label>
                            <input type="text" class="form-input item-note" placeholder="특이사항">
                        </div>
                        <div style="padding-top: 28px;">
                            <button class="btn btn-sm" onclick="removeItemRow(this)" style="padding: 8px; background: #f44336; color: white; border: none; cursor: pointer; border-radius: 4px;" title="삭제">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // 품목 일괄 저장
        async function saveBulkItems() {
            const categoryName = document.getElementById('itemCategory').value;

            if (!categoryName) {
                alert('사업을 선택하세요.');
                return;
            }

            const category = budgetData.categories[categoryName];
            const categoryId = category.id;

            // 모든 품목 행 수집
            const itemRows = document.querySelectorAll('.item-row');
            const items = [];

            for (const row of itemRows) {
                const name = row.querySelector('.item-name').value.trim();
                const company = row.querySelector('.item-company').value.trim();
                const phone = row.querySelector('.item-phone').value.trim();
                const price = parseInt(row.querySelector('.item-price').value) || 0;
                const quantity = parseInt(row.querySelector('.item-quantity').value) || 1;
                const note = row.querySelector('.item-note').value.trim();

                if (!name) {
                    alert('모든 품목의 품목명을 입력하세요.');
                    return;
                }

                if (price <= 0) {
                    alert('모든 품목의 올바른 단가를 입력하세요.');
                    return;
                }

                items.push({
                    categoryId,
                    name,
                    company,
                    phone,
                    price,
                    quantity,
                    note
                });
            }

            if (items.length === 0) {
                alert('등록할 품목이 없습니다.');
                return;
            }

            try {
                // 각 품목을 순차적으로 등록
                for (const itemData of items) {
                    const response = await fetch(`${API_BASE_URL}/items`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(itemData)
                    });

                    if (!response.ok) throw new Error('저장 실패');
                }

                alert(`${items.length}개 품목이 등록되었습니다.`);
                await loadData();
                closeItemModal();
            } catch (error) {
                console.error('품목 일괄 저장 오류:', error);
                alert('저장 중 오류가 발생했습니다.');
            }
        }

        async function saveItem() {
            const categoryName = document.getElementById('itemCategory').value;
            const name = document.getElementById('itemName').value.trim();
            const company = document.getElementById('itemCompany').value.trim();
            const phone = document.getElementById('itemPhone').value.trim();
            const price = parseInt(document.getElementById('itemPrice').value) || 0;
            const quantity = parseInt(document.getElementById('itemQuantity').value) || 1;
            const note = document.getElementById('itemNote').value.trim();

            if (!categoryName) {
                alert('사업을 선택하세요.');
                return;
            }

            if (!name) {
                alert('품목명을 입력하세요.');
                return;
            }

            if (price <= 0) {
                alert('올바른 단가를 입력하세요.');
                return;
            }

            try {
                // 카테고리 ID 가져오기
                const category = budgetData.categories[categoryName];
                const categoryId = editingItemId ? editingItemCategoryId : category.id;

                const itemData = {
                    categoryId: categoryId,
                    name: name,
                    company: company,
                    phone: phone,
                    price: price,
                    quantity: quantity,
                    note: note
                };

                // 수정 모드인지 확인
                const isEdit = editingItemId !== null;
                const url = isEdit
                    ? `${API_BASE_URL}/items/${editingItemId}`
                    : `${API_BASE_URL}/items`;
                const method = isEdit ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(itemData)
                });

                if (!response.ok) throw new Error('저장 실패');

                // 수정 모드 초기화
                editingItemId = null;
                editingItemCategoryId = null;

                await loadData();
                closeItemModal();
            } catch (error) {
                console.error('품목 저장 오류:', error);
                alert('저장 중 오류가 발생했습니다.');
            }
        }

        async function editItem(categoryName, itemId) {
            const category = budgetData.categories[categoryName];
            if (!category) {
                alert('카테고리를 찾을 수 없습니다.');
                return;
            }

            const item = category.items.find(i => i.id === itemId);
            if (!item) {
                alert('품목을 찾을 수 없습니다.');
                return;
            }

            // 수정 모드로 설정
            editingItemId = itemId;
            editingItemCategoryId = category.id;

            // 모달 열기
            document.getElementById('itemModal').classList.add('active');

            // 기존 데이터 채우기
            document.getElementById('itemCategory').value = categoryName;
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemCompany').value = item.company || '';
            document.getElementById('itemPhone').value = item.phone || '';
            document.getElementById('itemPrice').value = item.price;
            document.getElementById('itemQuantity').value = item.quantity;
            document.getElementById('itemNote').value = item.note || '';

            // 서류 가이드 업데이트
            updateDocGuide();

            // 버튼 텍스트 변경
            const saveBtn = document.querySelector('#itemModal .btn-primary');
            if (saveBtn) {
                saveBtn.textContent = '수정';
            }
        }

        async function deleteItem(category, itemId) {
            if (!confirm('이 품목을 삭제하시겠습니까?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/items/${itemId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('삭제 실패');

                await loadData();
            } catch (error) {
                console.error('품목 삭제 오류:', error);
                alert('삭제 중 오류가 발생했습니다.');
            }
        }

        // Inline 편집 기능
        let currentEditingCell = null;

        function makeCellEditable(cell, type, id) {
            console.log('makeCellEditable 호출:', { cell, type, id, field: cell.dataset.field });

            // 이미 편집 중이면 무시
            if (currentEditingCell) {
                console.log('이미 편집 중인 셀이 있음');
                return;
            }

            currentEditingCell = cell;
            const field = cell.dataset.field;
            let originalValue = cell.textContent.trim();

            // '-'는 빈 값으로 처리
            if (originalValue === '-') {
                originalValue = '';
            }

            // 숫자 필드인 경우 콤마 제거
            if (field === 'budget' || field === 'price') {
                originalValue = originalValue.replace(/,/g, '');
            }

            // 날짜 필드인 경우 형식 변환
            if (field === 'paymentDate' && originalValue && originalValue !== '-') {
                // YYYY-MM-DD 형식으로 변환
                const parts = originalValue.split('-');
                if (parts.length === 3) {
                    originalValue = `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
                }
            }

            cell.classList.add('editing');

            // 지출상태, 대분류, 구분은 select로 처리
            if (field === 'status' || field === 'mainCategory' || field === 'type') {
                const select = document.createElement('select');
                select.style.cssText = 'width: 100%; border: 2px solid #2196F3; padding: 8px; font-size: inherit; font-family: inherit;';

                let options = [];
                let currentValue = originalValue;

                if (field === 'status') {
                    options = ['계획', '진행중', '지출완료', '보류'];
                } else if (field === 'mainCategory') {
                    // 대분류 옵션 (기존에 사용된 것들 + 일반적인 예산 항목)
                    options = ['인건비', '재료비', '경비', '사무실조성', '시설비', '운영비', '사업비', '기타'];
                    // '└ ' 제거
                    if (currentValue.startsWith('└ ')) {
                        currentValue = currentValue.substring(2).trim();
                    }
                } else if (field === 'type') {
                    // 구분 옵션
                    options = ['물품', '용역', '공사'];
                }

                options.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    if (option === currentValue) {
                        optionElement.selected = true;
                    }
                    select.appendChild(optionElement);
                });

                cell.innerHTML = '';
                cell.appendChild(select);
                select.focus();

                select.addEventListener('keydown', async (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        await saveCellEdit(cell, type, id, field, select.value, originalValue);
                    } else if (e.key === 'Escape') {
                        cancelCellEdit(cell, originalValue, field);
                    }
                });

                select.addEventListener('blur', async () => {
                    if (currentEditingCell === cell) {
                        await saveCellEdit(cell, type, id, field, select.value, originalValue);
                    }
                });
                return;
            }

            // input 타입 결정
            let inputType = 'text';
            if (field === 'paymentDate') {
                inputType = 'date';
            } else if (field === 'budget' || field === 'price' || field === 'quantity') {
                inputType = 'number';
            }

            const input = document.createElement('input');
            input.type = inputType;
            input.value = originalValue;

            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
            input.select();

            // Enter 키로 저장
            input.addEventListener('keydown', async (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    await saveCellEdit(cell, type, id, field, input.value, originalValue);
                } else if (e.key === 'Escape') {
                    cancelCellEdit(cell, originalValue, field);
                }
            });

            // 포커스를 잃으면 저장
            input.addEventListener('blur', async () => {
                if (currentEditingCell === cell) {
                    await saveCellEdit(cell, type, id, field, input.value, originalValue);
                }
            });
        }

        async function saveCellEdit(cell, type, id, field, newValue, originalValue) {
            newValue = newValue.trim();

            // 값이 변경되지 않았으면 취소
            if (newValue === originalValue || (newValue === '' && originalValue === '-')) {
                cancelCellEdit(cell, originalValue, field);
                return;
            }

            try {
                if (type === 'category') {
                    await updateCategoryField(id, field, newValue);
                } else if (type === 'item') {
                    await updateItemField(id, field, newValue);
                }

                // 데이터 다시 로드
                await loadData();
                currentEditingCell = null;
            } catch (error) {
                console.error('저장 오류:', error);
                console.error('오류 상세:', error.message);
                console.error('오류 스택:', error.stack);
                alert('저장 중 오류가 발생했습니다.\n\n오류: ' + error.message + '\n\n브라우저 콘솔(F12)을 확인해주세요.');
                cancelCellEdit(cell, originalValue, field);
            }
        }

        function cancelCellEdit(cell, originalValue, field) {
            cell.classList.remove('editing');

            // 표시 형식으로 복원
            let displayValue = originalValue;
            if (field === 'budget' || field === 'price') {
                displayValue = formatNumber(parseInt(originalValue) || 0);
            } else if (field === 'status') {
                // 지출상태는 badge로 복원
                const statusClass = originalValue.replace(/\s/g, '');
                cell.innerHTML = `<span class="status-badge ${originalValue}">${originalValue}</span>`;
                currentEditingCell = null;
                return;
            } else if (field === 'type') {
                // 구분은 category-badge로 복원
                cell.innerHTML = `<span class="category-badge ${originalValue}">${originalValue}</span>`;
                currentEditingCell = null;
                return;
            } else if (!originalValue) {
                displayValue = '-';
            }

            cell.textContent = displayValue;
            currentEditingCell = null;
        }

        async function updateCategoryField(categoryName, field, value) {
            const category = budgetData.categories[categoryName];
            if (!category) {
                throw new Error('카테고리를 찾을 수 없습니다.');
            }

            // 필드 값 변환
            let updateData = {
                name: category.name,
                mainCategory: category.mainCategory,
                subCategory: category.subCategory,
                type: category.type,
                budget: category.budget,
                status: category.status,
                paymentDate: category.paymentDate,
                note: category.note
            };

            // 해당 필드만 업데이트
            if (field === 'budget') {
                updateData.budget = parseInt(value) || 0;
            } else if (field === 'paymentDate') {
                updateData.paymentDate = value || null;
            } else if (field === 'name') {
                updateData.name = value;
            } else if (field === 'mainCategory') {
                updateData.mainCategory = value;
            } else if (field === 'subCategory') {
                updateData.subCategory = value;
            } else if (field === 'status') {
                updateData.status = value;
            } else if (field === 'type') {
                updateData.type = value;
            }

            const response = await fetch(`${API_BASE_URL}/categories/${category.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updateData)
            });

            if (!response.ok) throw new Error('업데이트 실패');
        }

        async function updateItemField(itemId, field, value) {
            console.log('updateItemField 호출:', { itemId, field, value });

            // 먼저 해당 품목 찾기
            let itemData = null;
            let categoryId = null;

            // itemId가 숫자인지 확인
            const numericItemId = Number(itemId);
            console.log('변환된 itemId:', numericItemId);

            for (const [catName, catData] of Object.entries(budgetData.categories)) {
                const item = catData.items.find(i => {
                    console.log('비교:', i.id, '===', numericItemId, '?', i.id === numericItemId);
                    return i.id === numericItemId;
                });
                if (item) {
                    itemData = item;
                    categoryId = catData.id;
                    console.log('품목 찾음:', { itemData, categoryId });
                    break;
                }
            }

            if (!itemData) {
                throw new Error('품목을 찾을 수 없습니다.');
            }

            console.log('찾은 품목 데이터:', itemData);

            // 업데이트할 데이터 준비
            let updateData = {
                categoryId: categoryId,
                name: itemData.name,
                company: itemData.company || '',
                phone: itemData.phone || '',
                price: itemData.price,
                quantity: itemData.quantity,
                note: itemData.note || ''
            };

            // 해당 필드만 업데이트
            if (field === 'name') {
                updateData.name = value;
            } else if (field === 'company') {
                updateData.company = value;
            } else if (field === 'phone') {
                updateData.phone = value;
            } else if (field === 'price') {
                updateData.price = parseInt(value) || 0;
            } else if (field === 'quantity') {
                updateData.quantity = parseInt(value) || 1;
            } else if (field === 'note') {
                updateData.note = value;
            }

            console.log('전송할 데이터:', updateData);

            const url = `${API_BASE_URL}/items/${itemId}`;
            console.log('요청 URL:', url);

            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updateData)
            });

            console.log('응답 상태:', response.status, response.statusText);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('업데이트 실패:', errorText);
                console.error('응답 상태:', response.status);
                throw new Error('업데이트 실패: ' + response.status + ' - ' + errorText);
            }

            const result = await response.json();
            console.log('업데이트 성공:', result);
        }

        // 서류 확인 모달
        function viewCategoryDocs(categoryName) {
            const category = budgetData.categories[categoryName];
            if (!category || category.items.length === 0) {
                alert('등록된 품목이 없습니다.');
                return;
            }

            let html = `
                <h4 style="margin-bottom: 15px; color: #003876; font-weight: 700;">[${categoryName}] 구비서류 제출 현황</h4>
            `;

            category.items.forEach((item, index) => {
                const totalAmount = item.price * item.quantity;
                const docs = getRequiredDocuments(category.type, totalAmount);
                const allDocs = [...docs.시행결의, ...docs.결과보고서, ...docs.지출];
                const checkedCount = item.checkedDocs ? item.checkedDocs.length : 0;

                html += `
                    <div class="doc-guide" style="margin-bottom: 15px;">
                        <div class="doc-guide-title">
                            ${index + 1}. ${item.name} (${formatNumber(totalAmount)}원)
                            <span style="margin-left: 10px; color: #2e7d32; font-weight: 700;">[제출: ${checkedCount}/${allDocs.length}건]</span>
                        </div>
                        ${item.company ? `<div style="font-size: 12px; color: #666; margin: 5px 0;">· 계약업체: ${item.company} ${item.phone ? '/ 연락처: ' + item.phone : ''}</div>` : ''}
                `;

                for (const [stage, docList] of Object.entries(docs)) {
                    if (docList.length > 0) {
                        html += `
                            <div class="doc-section">
                                <div class="doc-section-title">[${stage}]</div>
                                <div class="doc-list">
                        `;
                        docList.forEach(doc => {
                            const checked = item.checkedDocs && item.checkedDocs.includes(doc);
                            const escapedDoc = doc.replace(/'/g, "\\'");
                            html += `
                                <div class="doc-item">
                                    <input type="checkbox" ${checked ? 'checked' : ''}
                                           onchange="toggleDocCheck('${categoryName}', ${item.id}, '${escapedDoc}', this.checked)"
                                           style="margin-right: 8px; cursor: pointer;">
                                    <span style="${checked ? 'color: #111; font-weight: 700;' : 'color: #666;'}">${doc}</span>
                                </div>
                            `;
                        });
                        html += `</div></div>`;
                    }
                }

                html += `</div>`;
            });

            document.getElementById('docModalBody').innerHTML = html;
            document.getElementById('docModal').classList.add('active');
        }

        function viewItemDocs(categoryName, itemIndex) {
            const category = budgetData.categories[categoryName];
            const item = category.items[itemIndex];
            const totalAmount = item.price * item.quantity;
            const docs = getRequiredDocuments(category.type, totalAmount);
            const allDocs = [...docs.시행결의, ...docs.결과보고서, ...docs.지출];
            const checkedCount = item.checkedDocs ? item.checkedDocs.length : 0;

            let html = `
                <h4 style="margin-bottom: 10px; color: #003876; font-weight: 700;">${item.name}</h4>
                <p style="margin-bottom: 15px; color: #666; line-height: 1.8;">
                    · 집행금액: ${formatNumber(totalAmount)}원<br>
                    · 사업구분: ${category.type}<br>
                    ${item.company ? `· 계약업체: ${item.company}<br>` : ''}
                    ${item.phone ? `· 연락처: ${item.phone}<br>` : ''}
                </p>
                <p style="margin-bottom: 15px; font-weight: 700; color: #2e7d32;">
                    서류 제출 현황: ${checkedCount}/${allDocs.length}건 완료
                </p>
                <div class="doc-guide">
            `;

            for (const [stage, docList] of Object.entries(docs)) {
                if (docList.length > 0) {
                    html += `
                        <div class="doc-section">
                            <div class="doc-section-title">[${stage}]</div>
                            <div class="doc-list">
                    `;
                    docList.forEach(doc => {
                        const checked = item.checkedDocs && item.checkedDocs.includes(doc);
                        const escapedDoc = doc.replace(/'/g, "\\'");
                        html += `
                            <div class="doc-item">
                                <input type="checkbox" ${checked ? 'checked' : ''}
                                       onchange="toggleDocCheck('${categoryName}', ${item.id}, '${escapedDoc}', this.checked)"
                                       style="margin-right: 8px; cursor: pointer;">
                                <span style="${checked ? 'color: #111; font-weight: 700;' : 'color: #666;'}">${doc}</span>
                            </div>
                        `;
                    });
                    html += `</div></div>`;
                }
            }

            html += `</div>`;

            document.getElementById('docModalBody').innerHTML = html;
            document.getElementById('docModal').classList.add('active');
        }

        // 서류 체크박스 토글
        async function toggleDocCheck(categoryName, itemId, docName, isChecked) {
            // budgetData에서 해당 품목 찾기
            const category = budgetData.categories[categoryName];
            if (!category) return;

            const item = category.items.find(i => i.id === itemId);
            if (!item) return;

            // checkedDocs 배열 초기화
            if (!item.checkedDocs) {
                item.checkedDocs = [];
            }

            // 체크 상태에 따라 배열 업데이트
            if (isChecked) {
                if (!item.checkedDocs.includes(docName)) {
                    item.checkedDocs.push(docName);
                }
            } else {
                item.checkedDocs = item.checkedDocs.filter(d => d !== docName);
            }

            // API로 데이터베이스에 저장
            try {
                const response = await fetch(`${API_BASE_URL}/items/${itemId}/checked-docs`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ checkedDocs: item.checkedDocs })
                });

                if (!response.ok) {
                    throw new Error('서류 체크 저장 실패');
                }
            } catch (error) {
                console.error('서류 체크 저장 오류:', error);
                alert('서류 체크 저장 중 오류가 발생했습니다.');
                // 실패 시 원래 상태로 복원
                if (isChecked) {
                    item.checkedDocs = item.checkedDocs.filter(d => d !== docName);
                } else {
                    item.checkedDocs.push(docName);
                }
                return;
            }

            // 제출 현황 업데이트
            updateDocSubmissionCount(categoryName, itemId);
        }

        function updateDocSubmissionCount(categoryName, itemId) {
            const category = budgetData.categories[categoryName];
            if (!category) return;

            const item = category.items.find(i => i.id === itemId);
            if (!item) return;

            const totalAmount = item.price * item.quantity;
            const docs = getRequiredDocuments(category.type, totalAmount);
            const allDocs = [...docs.시행결의, ...docs.결과보고서, ...docs.지출];
            const checkedCount = item.checkedDocs ? item.checkedDocs.length : 0;

            // 모달이 열려있으면 카운트 업데이트
            const modalBody = document.getElementById('docModalBody');
            if (modalBody && modalBody.innerHTML.includes(item.name)) {
                // 현재 모달의 카운트 텍스트 찾아서 업데이트
                const countSpans = modalBody.querySelectorAll('span');
                countSpans.forEach(span => {
                    if (span.textContent.includes('[제출:') || span.textContent.includes('서류 제출 현황:')) {
                        if (span.textContent.includes(item.name) || span.parentElement.textContent.includes('서류 제출 현황:')) {
                            const newText = span.textContent.replace(/\d+\/\d+/, `${checkedCount}/${allDocs.length}`);
                            span.textContent = newText;
                        }
                    }
                });
            }
        }

        function closeDocModal() {
            document.getElementById('docModal').classList.remove('active');
        }

        // 전체 초기화
        function resetAllData() {
            if (!confirm('※ 주의: 모든 예산 데이터가 삭제됩니다.\n정말로 초기화하시겠습니까?')) {
                return;
            }
            budgetData = { categories: {} };
            saveData();
            renderAll();
            alert('전체 데이터가 초기화되었습니다.');
        }

        // 초기 데이터는 Neon DB에 직접 입력하여 사용
        // initial-data.sql 파일을 Neon DB SQL Editor에서 실행하세요
        function exportToExcel() {
            if (Object.keys(budgetData.categories).length === 0) {
                alert('내보낼 데이터가 없습니다.');
                return;
            }

            try {
                const wb = XLSX.utils.book_new();

            // 1. 전체 요약 시트
            const summaryData = [];
            summaryData.push(['[국립공원공단 야생생물보전원 사육곰 보호센터] 2025년도 예산 집행 관리 대장']);
            summaryData.push(['작성일자', new Date().toLocaleDateString('ko-KR')]);
            summaryData.push(['작성자', currentUserInfo.name ? `${currentUserInfo.name} (${currentUserInfo.department})` : '미기재']);
            summaryData.push([]);

            let totalBudget = 0;
            let totalUsed = 0;

            for (const [name, data] of Object.entries(budgetData.categories)) {
                totalBudget += data.budget;
                const used = data.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                totalUsed += used;
            }

            summaryData.push(['구분', '금액(원)']);
            summaryData.push(['총 편성예산', totalBudget]);
            summaryData.push(['집행액', totalUsed]);
            summaryData.push(['잔액', totalBudget - totalUsed]);
            summaryData.push(['집행률(%)', ((totalUsed / totalBudget) * 100).toFixed(1)]);
            summaryData.push([]);
            summaryData.push(['사업별 예산 집행 현황 (대분류별)']);
            summaryData.push(['연번', '대분류', '소분류', '사업명', '구분', '편성예산', '집행액', '잔액', '집행률(%)', '상태', '비고']);

            // 대분류별로 그룹화
            const grouped = {};
            Object.entries(budgetData.categories).forEach(([name, data]) => {
                const mainCat = data.mainCategory || '미분류';
                if (!grouped[mainCat]) {
                    grouped[mainCat] = [];
                }
                grouped[mainCat].push([name, data]);
            });

            let index = 1;
            for (const [mainCat, items] of Object.entries(grouped)) {
                // 대분류별 합계 계산
                let mainBudget = 0;
                let mainUsed = 0;
                items.forEach(([name, data]) => {
                    mainBudget += data.budget;
                    mainUsed += data.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                });
                const mainRemaining = mainBudget - mainUsed;
                const mainRate = mainBudget > 0 ? ((mainUsed / mainBudget) * 100).toFixed(1) : 0;

                // 대분류 합계 행
                summaryData.push([
                    '',
                    `■ ${mainCat}`,
                    '',
                    `총 ${items.length}개`,
                    '',
                    mainBudget,
                    mainUsed,
                    mainRemaining,
                    mainRate,
                    '',
                    ''
                ]);

                // 세부 사업
                items.forEach(([name, data]) => {
                    const used = data.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                    const remaining = data.budget - used;
                    const rate = data.budget > 0 ? ((used / data.budget) * 100).toFixed(1) : 0;

                    summaryData.push([
                        index++,
                        mainCat,
                        data.subCategory || '-',
                        name,
                        data.type,
                        data.budget,
                        used,
                        remaining,
                        rate,
                        data.status || '계획',
                        data.note || ''
                    ]);
                });
            }

            const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
            ws1['!cols'] = [{wch: 8}, {wch: 18}, {wch: 15}, {wch: 25}, {wch: 8}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 12}, {wch: 10}, {wch: 30}];
            XLSX.utils.book_append_sheet(wb, ws1, '전체요약');

            // 2. 사업별 세부 시트
            for (const [name, data] of Object.entries(budgetData.categories)) {
                const sheetData = [];
                sheetData.push([`[${name}] 세부 품목별 집행내역`]);
                sheetData.push(['대분류', data.mainCategory || '미분류']);
                sheetData.push(['소분류', data.subCategory || '-']);
                sheetData.push(['사업구분', data.type]);
                sheetData.push(['편성예산', data.budget + '원']);
                sheetData.push(['비고사항', data.note || '-']);
                sheetData.push([]);
                sheetData.push(['연번', '품목명', '계약업체', '연락처', '단가(원)', '수량', '합계(원)', '비고', '필요서류', '제출서류']);

                data.items.forEach((item, idx) => {
                    const total = item.price * item.quantity;
                    const docs = getRequiredDocuments(data.type, total);
                    const allDocs = [...docs.시행결의, ...docs.결과보고서, ...docs.지출];
                    const docStr = allDocs.join(', ');
                    const checkedDocsStr = item.checkedDocs && item.checkedDocs.length > 0 ? item.checkedDocs.join(', ') : '-';

                    sheetData.push([
                        idx + 1,
                        item.name,
                        item.company || '-',
                        item.phone || '-',
                        item.price,
                        item.quantity,
                        total,
                        item.note || '-',
                        docStr,
                        checkedDocsStr
                    ]);
                });

                const used = data.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                sheetData.push([]);
                sheetData.push(['', '', '', '', '소계', used]);
                sheetData.push(['', '', '', '', '잔액', data.budget - used]);

                const ws = XLSX.utils.aoa_to_sheet(sheetData);
                ws['!cols'] = [{wch: 6}, {wch: 25}, {wch: 20}, {wch: 15}, {wch: 12}, {wch: 8}, {wch: 12}, {wch: 20}, {wch: 50}, {wch: 50}];

                const sheetName = name.length > 31 ? name.substring(0, 31) : name;
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
            }

            // 3. 전체 품목 리스트
            const allItemsData = [];
            allItemsData.push(['전체 품목별 집행내역 (구비서류 포함)']);
            allItemsData.push([]);
            allItemsData.push(['연번', '대분류', '소분류', '사업명', '구분', '품목명', '계약업체', '연락처', '단가(원)', '수량', '합계(원)', '비고', '필요서류', '제출서류', '제출율']);

            let itemNumber = 1;
            for (const [categoryName, data] of Object.entries(budgetData.categories)) {
                data.items.forEach(item => {
                    const total = item.price * item.quantity;
                    const docs = getRequiredDocuments(data.type, total);
                    const allDocs = [...docs.시행결의, ...docs.결과보고서, ...docs.지출];
                    const checkedDocs = item.checkedDocs ? item.checkedDocs.join(', ') : '-';
                    const completionRate = item.checkedDocs ? `${item.checkedDocs.length}/${allDocs.length}` : `0/${allDocs.length}`;

                    allItemsData.push([
                        itemNumber++,
                        data.mainCategory || '미분류',
                        data.subCategory || '-',
                        categoryName,
                        data.type,
                        item.name,
                        item.company || '-',
                        item.phone || '-',
                        item.price,
                        item.quantity,
                        total,
                        item.note || '-',
                        allDocs.join(', '),
                        checkedDocs,
                        completionRate
                    ]);
                });
            }

            const ws3 = XLSX.utils.aoa_to_sheet(allItemsData);
            ws3['!cols'] = [{wch: 6}, {wch: 18}, {wch: 15}, {wch: 20}, {wch: 8}, {wch: 25}, {wch: 20}, {wch: 15}, {wch: 12}, {wch: 8}, {wch: 12}, {wch: 20}, {wch: 50}, {wch: 50}, {wch: 10}];
            XLSX.utils.book_append_sheet(wb, ws3, '전체품목');

            // 파일 다운로드
            const today = new Date();
                const dateStr = `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;
                const fileName = `[국립공원공단_야생생물보전원]사육곰보호센터_예산관리대장_${dateStr}.xlsx`;

                XLSX.writeFile(wb, fileName);
                console.log('엑셀 파일 다운로드 완료:', fileName);
            } catch (error) {
                console.error('엑셀 다운로드 오류:', error);
                alert('엑셀 다운로드 중 오류가 발생했습니다.\n브라우저 콘솔을 확인해주세요.\n\n오류: ' + error.message);
            }
        }

        // 선택된 항목만 엑셀로 다운로드
        function exportSelectedToExcel() {
            const selectedCategories = getSelectedCategories();
            const selectedItems = getSelectedItems();

            if (selectedCategories.length === 0 && selectedItems.length === 0) {
                alert('다운로드할 사업 또는 품목을 선택해주세요.');
                return;
            }

            try {
                const wb = XLSX.utils.book_new();

                // 선택된 데이터만 필터링
                const filteredData = {};

                // 1. 사업 전체가 선택된 경우
                selectedCategories.forEach(categoryName => {
                    if (budgetData.categories[categoryName]) {
                        filteredData[categoryName] = budgetData.categories[categoryName];
                    }
                });

                // 2. 개별 품목이 선택된 경우 - 품목만 필터링
                selectedItems.forEach(({category, index}) => {
                    if (budgetData.categories[category]) {
                        if (!filteredData[category]) {
                            // 해당 카테고리가 아직 추가되지 않았다면 복사본 생성
                            filteredData[category] = {
                                ...budgetData.categories[category],
                                items: []
                            };
                        }
                        // 선택된 품목만 추가 (중복 방지)
                        const item = budgetData.categories[category].items[index];
                        if (item && !filteredData[category].items.some(i => i === item)) {
                            filteredData[category].items.push(item);
                        }
                    }
                });

                if (Object.keys(filteredData).length === 0) {
                    alert('선택된 데이터가 없습니다.');
                    return;
                }

                // 1. 전체 요약 시트
                const summaryData = [];
                summaryData.push(['[국립공원공단 야생생물보전원 사육곰 보호센터] 선택 항목 예산 집행 관리']);
                summaryData.push(['작성일자', new Date().toLocaleDateString('ko-KR')]);
                summaryData.push(['작성자', currentUserInfo.name ? `${currentUserInfo.name} (${currentUserInfo.department})` : '미기재']);
                summaryData.push([]);

                let totalBudget = 0;
                let totalUsed = 0;

                for (const [name, data] of Object.entries(filteredData)) {
                    totalBudget += data.budget;
                    const used = data.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                    totalUsed += used;
                }

                summaryData.push(['구분', '금액(원)']);
                summaryData.push(['총 편성예산', totalBudget]);
                summaryData.push(['집행액', totalUsed]);
                summaryData.push(['잔액', totalBudget - totalUsed]);
                summaryData.push(['집행률(%)', totalBudget > 0 ? ((totalUsed / totalBudget) * 100).toFixed(1) : 0]);
                summaryData.push([]);
                summaryData.push(['선택된 사업별 예산 집행 현황']);
                summaryData.push(['연번', '대분류', '소분류', '사업명', '구분', '편성예산', '집행액', '잔액', '집행률(%)', '상태', '비고']);

                let index = 1;
                for (const [name, data] of Object.entries(filteredData)) {
                    const used = data.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                    const remaining = data.budget - used;
                    const rate = data.budget > 0 ? ((used / data.budget) * 100).toFixed(1) : 0;

                    summaryData.push([
                        index++,
                        data.mainCategory || '미분류',
                        data.subCategory || '-',
                        name,
                        data.type,
                        data.budget,
                        used,
                        remaining,
                        rate,
                        data.status || '계획',
                        data.note || ''
                    ]);
                }

                const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
                ws1['!cols'] = [{wch: 8}, {wch: 18}, {wch: 15}, {wch: 25}, {wch: 8}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 12}, {wch: 10}, {wch: 30}];
                XLSX.utils.book_append_sheet(wb, ws1, '선택항목요약');

                // 2. 사업별 세부 시트
                for (const [name, data] of Object.entries(filteredData)) {
                    if (data.items.length === 0) continue; // 품목이 없는 경우 스킵

                    const sheetData = [];
                    sheetData.push([`[${name}] 세부 품목별 집행내역`]);
                    sheetData.push(['대분류', data.mainCategory || '미분류']);
                    sheetData.push(['소분류', data.subCategory || '-']);
                    sheetData.push(['사업구분', data.type]);
                    sheetData.push(['편성예산', data.budget + '원']);
                    sheetData.push(['비고사항', data.note || '-']);
                    sheetData.push([]);
                    sheetData.push(['연번', '품목명', '계약업체', '연락처', '단가(원)', '수량', '합계(원)', '비고', '필요서류', '제출서류']);

                    data.items.forEach((item, idx) => {
                        const total = item.price * item.quantity;
                        const docs = getRequiredDocuments(data.type, total);
                        const allDocs = [...docs.시행결의, ...docs.결과보고서, ...docs.지출];
                        const docStr = allDocs.join(', ');
                        const checkedDocsStr = item.checkedDocs && item.checkedDocs.length > 0 ? item.checkedDocs.join(', ') : '-';

                        sheetData.push([
                            idx + 1,
                            item.name,
                            item.company || '-',
                            item.phone || '-',
                            item.price,
                            item.quantity,
                            total,
                            item.note || '-',
                            docStr,
                            checkedDocsStr
                        ]);
                    });

                    const used = data.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                    sheetData.push([]);
                    sheetData.push(['', '', '', '', '소계', used]);
                    sheetData.push(['', '', '', '', '잔액', data.budget - used]);

                    const ws = XLSX.utils.aoa_to_sheet(sheetData);
                    ws['!cols'] = [{wch: 6}, {wch: 25}, {wch: 20}, {wch: 15}, {wch: 12}, {wch: 8}, {wch: 12}, {wch: 20}, {wch: 50}, {wch: 50}];

                    const sheetName = name.length > 31 ? name.substring(0, 31) : name;
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                }

                // 3. 선택된 품목 리스트
                const allItemsData = [];
                allItemsData.push(['선택된 품목별 집행내역 (구비서류 포함)']);
                allItemsData.push([]);
                allItemsData.push(['연번', '대분류', '소분류', '사업명', '구분', '품목명', '계약업체', '연락처', '단가(원)', '수량', '합계(원)', '비고', '필요서류', '제출서류', '제출율']);

                let itemNumber = 1;
                for (const [categoryName, data] of Object.entries(filteredData)) {
                    data.items.forEach(item => {
                        const total = item.price * item.quantity;
                        const docs = getRequiredDocuments(data.type, total);
                        const allDocs = [...docs.시행결의, ...docs.결과보고서, ...docs.지출];
                        const checkedDocs = item.checkedDocs ? item.checkedDocs.join(', ') : '-';
                        const completionRate = item.checkedDocs ? `${item.checkedDocs.length}/${allDocs.length}` : `0/${allDocs.length}`;

                        allItemsData.push([
                            itemNumber++,
                            data.mainCategory || '미분류',
                            data.subCategory || '-',
                            categoryName,
                            data.type,
                            item.name,
                            item.company || '-',
                            item.phone || '-',
                            item.price,
                            item.quantity,
                            total,
                            item.note || '-',
                            allDocs.join(', '),
                            checkedDocs,
                            completionRate
                        ]);
                    });
                }

                const ws3 = XLSX.utils.aoa_to_sheet(allItemsData);
                ws3['!cols'] = [{wch: 6}, {wch: 18}, {wch: 15}, {wch: 20}, {wch: 8}, {wch: 25}, {wch: 20}, {wch: 15}, {wch: 12}, {wch: 8}, {wch: 12}, {wch: 20}, {wch: 50}, {wch: 50}, {wch: 10}];
                XLSX.utils.book_append_sheet(wb, ws3, '선택품목');

                // 파일 다운로드
                const today = new Date();
                const dateStr = `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;
                const fileName = `[국립공원공단_야생생물보전원]사육곰보호센터_선택항목_${dateStr}.xlsx`;

                XLSX.writeFile(wb, fileName);
                console.log('선택 항목 엑셀 파일 다운로드 완료:', fileName);
            } catch (error) {
                console.error('선택 항목 엑셀 다운로드 오류:', error);
                alert('엑셀 다운로드 중 오류가 발생했습니다.\n브라우저 콘솔을 확인해주세요.\n\n오류: ' + error.message);
            }
        }

        // 모달 배경 클릭시 닫기
        document.getElementById('categoryModal').addEventListener('click', function(e) {
            if (e.target === this) closeCategoryModal();
        });

        document.getElementById('itemModal').addEventListener('click', function(e) {
            if (e.target === this) closeItemModal();
        });

        document.getElementById('docModal').addEventListener('click', function(e) {
            if (e.target === this) closeDocModal();
        });

        // 체크박스 전체 선택/해제 - 사업
        function toggleAllCategorySelection() {
            const masterCheckbox = document.getElementById('selectAllCategories');
            const checkboxes = document.querySelectorAll('.category-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = masterCheckbox.checked;
            });
        }

        // 체크박스 전체 선택/해제 - 품목
        function toggleAllItemSelection() {
            const masterCheckbox = document.getElementById('selectAllItems');
            const checkboxes = document.querySelectorAll('.item-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = masterCheckbox.checked;
            });
        }

        // 선택된 사업 가져오기
        function getSelectedCategories() {
            const selected = [];
            document.querySelectorAll('.category-checkbox:checked').forEach(cb => {
                selected.push(cb.getAttribute('data-category'));
            });
            return selected;
        }

        // 선택된 품목 가져오기
        function getSelectedItems() {
            const selected = [];
            document.querySelectorAll('.item-checkbox:checked').forEach(cb => {
                selected.push({
                    category: cb.getAttribute('data-category'),
                    index: parseInt(cb.getAttribute('data-index'))
                });
            });
            return selected;
        }

        // 필터 상태
        let currentFilters = {
            mainCategory: '',
            status: '',
            type: '',
            dateStart: '',
            dateEnd: '',
            search: ''
        };

        // 필터 적용
        function applyFilters() {
            currentFilters.mainCategory = document.getElementById('filterMainCategory').value;
            currentFilters.status = document.getElementById('filterStatus').value;
            currentFilters.type = document.getElementById('filterType').value;
            currentFilters.dateStart = document.getElementById('filterDateStart').value;
            currentFilters.dateEnd = document.getElementById('filterDateEnd').value;
            currentFilters.search = document.getElementById('filterSearch').value.toLowerCase();

            renderAll();
        }

        // 필터 초기화
        function resetFilters() {
            document.getElementById('filterMainCategory').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterType').value = '';
            document.getElementById('filterDateStart').value = '';
            document.getElementById('filterDateEnd').value = '';
            document.getElementById('filterSearch').value = '';

            currentFilters = {
                mainCategory: '',
                status: '',
                type: '',
                dateStart: '',
                dateEnd: '',
                search: ''
            };

            renderAll();
        }

        // 데이터 필터링 함수
        function getFilteredCategories() {
            const filtered = {};

            for (const [name, data] of Object.entries(budgetData.categories)) {
                // 대분류 필터
                if (currentFilters.mainCategory && data.mainCategory !== currentFilters.mainCategory) {
                    continue;
                }

                // 지출상태 필터
                if (currentFilters.status && data.status !== currentFilters.status) {
                    continue;
                }

                // 구분 필터
                if (currentFilters.type && data.type !== currentFilters.type) {
                    continue;
                }

                // 지출일 필터
                if (currentFilters.dateStart || currentFilters.dateEnd) {
                    const paymentDate = data.paymentDate;

                    // 지출일이 없으면 제외
                    if (!paymentDate) {
                        continue;
                    }

                    // 시작일 체크
                    if (currentFilters.dateStart && paymentDate < currentFilters.dateStart) {
                        continue;
                    }

                    // 종료일 체크
                    if (currentFilters.dateEnd && paymentDate > currentFilters.dateEnd) {
                        continue;
                    }
                }

                // 검색어 필터
                if (currentFilters.search && !name.toLowerCase().includes(currentFilters.search)) {
                    continue;
                }

                filtered[name] = data;
            }

            return filtered;
        }

        // 초기 로드 - 로그인 체크 후 데이터 로드
        window.addEventListener('DOMContentLoaded', checkLogin);
    </script>
</body>
</html>
